<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Cyberflow</title>
    <description>My Personal Blog</description>
    <link>https://cyberflow.net/</link>
    <atom:link href="https://cyberflow.net/sitemap.xml" rel="self" type="application/rss+xml"/>
    <pubDate>Fri, 03 Jun 2016 12:54:43 +0300</pubDate>
    <lastBuildDate>Fri, 03 Jun 2016 12:54:43 +0300</lastBuildDate>
    <generator>Jekyll v3.0.3</generator>
    
      <item>
        <title>Миграция старых indices elasticsearch на другую ноду</title>
        <description>&lt;p&gt;Я использую &lt;code class=&quot;highlighter-rouge&quot;&gt;elasticsearch&lt;/code&gt; для централизованного хранения логов с серверов. Логов хранится много и каждый новый индекс ест ресурсы на сервере (статью об оптимизации используемых ресурсов для одной ноды можно посмотреть &lt;a href=&quot;/linux/monitoring/2016/05/12/optimization-standalone-elasticsearch-in-elk-stack.html&quot;&gt;здесь&lt;/a&gt;). Однако это решение не спасает при хранении логов за очень большие периоды, в связи с чем я решил рассмотреть вариант хранения старых логов на отдельном сервере.&lt;/p&gt;

&lt;p&gt;Т.к. речь идет именно о логах, то шансы изменения данных из прошлого стремятся к нулю. Это позволяет нам не думать о необходимости записи в старые индексы и просто хранить их на сервере (например более дешевом с медленными дисками).
Генеральная идея состоит в том, чтобы добавить дополнительную ноду данных в кластер и распределять индексы (indices) в зависимости от времени их создания.&lt;/p&gt;

&lt;!--more--&gt;

&lt;h2 id=&quot;section&quot;&gt;Настройка кластера&lt;/h2&gt;

&lt;h3 id=&quot;section-1&quot;&gt;Настройка мастер ноды&lt;/h3&gt;
&lt;p&gt;Пропуская процесс установки &lt;code class=&quot;highlighter-rouge&quot;&gt;elasticsearch&lt;/code&gt; укажу лишь необходимые настройки:&lt;/p&gt;

&lt;blockquote class=&quot;filename&quot;&gt;
  &lt;p&gt;elasticsearch.yml&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;node.master&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;true&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;node.data&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;true&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;node.node_type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;hot&lt;/span&gt;
&lt;span class=&quot;nn&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;discovery.zen.ping.multicast.enabled&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;false&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;discovery.zen.ping.unicast.hosts&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;10.0.0.2&quot;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Нода будет иметь тэг &lt;code class=&quot;highlighter-rouge&quot;&gt;hot&lt;/code&gt; и хранит индексы для быстрого доступа.&lt;/p&gt;

&lt;h3 id=&quot;section-2&quot;&gt;Настройка ноды дынных&lt;/h3&gt;

&lt;blockquote class=&quot;filename&quot;&gt;
  &lt;p&gt;elasticsearch.yml&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;s&quot;&gt;node.master&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;false&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;node.data&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;true&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;node.node_type&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;warm&lt;/span&gt;
&lt;span class=&quot;nn&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;discovery.zen.ping.multicast.enabled&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;false&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;discovery.zen.ping.unicast.hosts&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;pi&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;10.0.0.1&quot;&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Нода будет иметь тэг &lt;code class=&quot;highlighter-rouge&quot;&gt;warm&lt;/code&gt; и мы будем перемещать на нее устаревшие indices.&lt;/p&gt;

&lt;h3 id=&quot;section-3&quot;&gt;Перемещение&lt;/h3&gt;
&lt;p&gt;После подготовки нод надо перезапустить &lt;code class=&quot;highlighter-rouge&quot;&gt;elasticsearch&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Убедиться, что ноды теперь в кластере можно командой:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-console&quot;&gt;$ curl http://localhost:9200/_nodes/process?pretty
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Следующая команда поставит аттрибут аллокации для всех индексов старше 7 дней:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-console&quot;&gt;$ curator --logfile /var/log/curator.log --loglevel INFO --logformat default --master-only --host localhost --port 9200 allocation --rule node_type=warm indices --time-unit days --older-than 7 --timestring &#39;%Y.%m.%d&#39;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Теперь можно добавить команду curator-а, описанную выше, в cron сервера и перемещение будет происходить автоматически.&lt;/p&gt;
</description>
        <pubDate>Fri, 03 Jun 2016 12:41:00 +0300</pubDate>
        <link>https://cyberflow.net/elasticsearch/2016/06/03/elasticsearch-cluster-for-old-indice.html</link>
        <guid isPermaLink="true">https://cyberflow.net/elasticsearch/2016/06/03/elasticsearch-cluster-for-old-indice.html</guid>
        
        <category>elasticsearch</category>
        
        
        <category>elasticsearch</category>
        
      </item>
    
      <item>
        <title>Оптимизация standalone сервера elasticsearch</title>
        <description>&lt;p&gt;При использовании &lt;a href=&quot;https://elastic.io&quot;&gt;elasticsearch&lt;/a&gt; для сбора и анализа логов возникает вопрос оптимизации для одного сервера. Т.к. &lt;code class=&quot;highlighter-rouge&quot;&gt;elasticsearch&lt;/code&gt; расчитан для использования в кластере, то большинство настроек “по умолчанию” выставлены так, что один сервер работает не эффективно. В этой заметке я разберу несколько примеров оптимизации &lt;code class=&quot;highlighter-rouge&quot;&gt;elasticsearch&lt;/code&gt; для работы на одном сервере.&lt;/p&gt;

&lt;!--more--&gt;

&lt;h3 id=&quot;shards&quot;&gt;Shards&lt;/h3&gt;
&lt;p&gt;Первое что нужно знать, что каждый шард использует пямять и процессор. При использовании &lt;code class=&quot;highlighter-rouge&quot;&gt;elasticsearch&lt;/code&gt; и &lt;code class=&quot;highlighter-rouge&quot;&gt;logstash&lt;/code&gt; получается, что каждый день &lt;code class=&quot;highlighter-rouge&quot;&gt;logstash&lt;/code&gt; создает новый &lt;code class=&quot;highlighter-rouge&quot;&gt;indice&lt;/code&gt;, а дефолтные настройки &lt;code class=&quot;highlighter-rouge&quot;&gt;elasticsearch&lt;/code&gt; создают 5 шардов в каждом индексе. В итоге с каждым днем кол-во шардов увеличивается вместе с утилизацие памяти и процессора.&lt;/p&gt;

&lt;p&gt;Первое что стоит сделать это изменить глобальные настройки &lt;code class=&quot;highlighter-rouge&quot;&gt;elasticsearch&lt;/code&gt; так, чтобы кол-во шардов было оптимальное. Если не планируется кластер, то и создавать большое кол-во шардов не имеет смысла. За эту настройку отвечает директива &lt;code class=&quot;highlighter-rouge&quot;&gt;index.number_of_shards&lt;/code&gt;. Добавив ее в конфиг можно установить кол-во создаваемых шардов для всех новых индексов. Как мне кажется, при использовании только одного сервера &lt;code class=&quot;highlighter-rouge&quot;&gt;elasticsearch&lt;/code&gt;, логично установить этот параметр равным 1.&lt;/p&gt;

&lt;h3 id=&quot;replics&quot;&gt;Replics&lt;/h3&gt;
&lt;p&gt;Реплики - еще один инструмент кластера &lt;code class=&quot;highlighter-rouge&quot;&gt;elasticsearch&lt;/code&gt;, который взаимодействует с шардами. Кол-во реплик указывают сколько “копий” шардов должно храниться на других нодах кластера, что в случае использования одной ноды не актуально. За эту настройку отвечает директива &lt;code class=&quot;highlighter-rouge&quot;&gt;index.number_of_replicas&lt;/code&gt;. Если сервер один, то и реплицировать некуда, устанавить этот параметр в 0 - логичное решение.&lt;/p&gt;

&lt;p&gt;Однако что делать, если сервер уже работает какое-то время с дефолтными настройками? Можно заметить, что API &lt;code class=&quot;highlighter-rouge&quot;&gt;elasticsearch&lt;/code&gt; возвращает следующее:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;curl -XGET http://localhost:9200/_cat/shards
logstash-2016.05.09 1 p STARTED    1520055  985.3mb 127.0.0.1 logstash1
logstash-2016.05.09 1 r UNASSIGNED
logstash-2016.05.09 3 p STARTED    1520640  985.9mb 127.0.0.1 logstash1
logstash-2016.05.09 3 r UNASSIGNED
logstash-2016.05.09 4 p STARTED    1520955  981.4mb 127.0.0.1 logstash1
logstash-2016.05.09 4 r UNASSIGNED
logstash-2016.05.09 2 p STARTED    1520377    966mb 127.0.0.1 logstash1
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;где &lt;code class=&quot;highlighter-rouge&quot;&gt;UNASSIGNED&lt;/code&gt; - это шарды-реплики, которые ожидают репликации.&lt;/p&gt;

&lt;p&gt;Исправить это можно следующим обращением к api:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -XPUT &quot;localhost:9200/logstash-2016.05.09/_settings&quot; -d &#39;{
    &quot;index&quot; : {
        &quot;number_of_replicas&quot; : 0
    }
}&#39;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;если количество индексов с шардами, ожидающими репликации большое, то можно воспользоваться следующим однострочником:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;ind &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;curl -XGET http://localhost:9200/_cat/shards | grep UNASSIGNED | awk &lt;span class=&quot;s1&quot;&gt;&#39;{print $1}&#39;&lt;/span&gt; | uniq&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;; &lt;span class=&quot;k&quot;&gt;do &lt;/span&gt;curl -XPUT &lt;span class=&quot;s2&quot;&gt;&quot;localhost:9200/&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$ind&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/_settings&quot;&lt;/span&gt; -d &lt;span class=&quot;s1&quot;&gt;&#39;{ &quot;index&quot; : { &quot;number_of_replicas&quot; : 0 } }&#39;&lt;/span&gt;; &lt;span class=&quot;k&quot;&gt;done&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
</description>
        <pubDate>Thu, 12 May 2016 12:12:00 +0300</pubDate>
        <link>https://cyberflow.net/monitoring/linux/2016/05/12/optimization-standalone-elasticsearch-in-elk-stack.html</link>
        <guid isPermaLink="true">https://cyberflow.net/monitoring/linux/2016/05/12/optimization-standalone-elasticsearch-in-elk-stack.html</guid>
        
        <category>monitoring</category>
        
        <category>linux</category>
        
        <category>elasticsearch</category>
        
        
        <category>monitoring</category>
        
        <category>linux</category>
        
      </item>
    
      <item>
        <title>Grafana/nginx auth proxy httpaswd</title>
        <description>&lt;p&gt;Краткое описание настройки &lt;a href=&quot;http://grafana.org&quot;&gt;Grafana&lt;/a&gt; (&amp;gt; 2.0) и nginx с использованием auth basic авторизации через файлы htpasswd.&lt;/p&gt;

&lt;p&gt;Необходимые настройки конфига Grafana:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[server]
protocol = http
http_port = 3000
domain = localhost
http_addr = 127.0.0.1
...
[auth.basic]
enabled=false
[users]
allow_sign_up = false
auto_assign_org = true
auto_assign_org_role = Editor
[auth.proxy]
enabled = true
header_name = X-WEBAUTH-USER
auto_sign_up = true
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;!--more--&gt;
&lt;p&gt;Настройка nginx:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;server {
  listen                &amp;lt;server_ip&amp;gt;:80;

  server_name           &amp;lt;server_hostname&amp;gt;;
  access_log            /var/log/nginx/grafana.access.log;

  location / {
    auth_basic            &#39;Restricted&#39;;
    auth_basic_user_file  &amp;lt;path/to/htpasswd_file&amp;gt;;
    proxy_set_header X-WEBAUTH-USER $remote_user;
    proxy_pass http://grafana;
  }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;После сделать рестарт сервера Grafana и nginx.&lt;/p&gt;
</description>
        <pubDate>Thu, 17 Mar 2016 17:25:00 +0200</pubDate>
        <link>https://cyberflow.net/linux/monitoring/2016/03/17/grafana-slash-nginx-auth-proxy-httpaswd.html</link>
        <guid isPermaLink="true">https://cyberflow.net/linux/monitoring/2016/03/17/grafana-slash-nginx-auth-proxy-httpaswd.html</guid>
        
        <category>monitoring</category>
        
        <category>linux</category>
        
        <category>grafana</category>
        
        <category>nginx</category>
        
        <category>auth</category>
        
        
        <category>linux</category>
        
        <category>monitoring</category>
        
      </item>
    
      <item>
        <title>Пробрасывание X сессии от пользователя к root</title>
        <description>&lt;p&gt;Сталкнулся с необходимостью запуска графической утилиты на удаленном сервере под пользователем root, но доступ для root по ssh закрыт.&lt;/p&gt;

&lt;p&gt;В итоге нашел такой workaround:&lt;/p&gt;

&lt;p&gt;Заходим на сервер под пользователем прокинув X сессию через ssh:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;~$ &lt;/span&gt;ssh -X user@hostname
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Находим X сессию, потом свитчемся в root:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;~$ &lt;/span&gt;xauth list
hostname/unix:10  MIT-MAGIC-COOKIE-1  f714ef310193878cae851635b871d840
&lt;span class=&quot;gp&quot;&gt;~$ &lt;/span&gt;sudo -s
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Добавляем имеющуюся сессию пользователю root&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gp&quot;&gt;~# &lt;/span&gt;xauth add hostname/unix:10  MIT-MAGIC-COOKIE-1 f714ef310193878cae851635b871d840
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Все! Можно запускать X приложение под root-ом.&lt;/p&gt;
</description>
        <pubDate>Wed, 09 Sep 2015 15:24:00 +0300</pubDate>
        <link>https://cyberflow.net/notice/linux/2015/09/09/use-ssh-x-session-from-user-to-root.html</link>
        <guid isPermaLink="true">https://cyberflow.net/notice/linux/2015/09/09/use-ssh-x-session-from-user-to-root.html</guid>
        
        <category>linux</category>
        
        <category>ssh</category>
        
        <category>xsession</category>
        
        
        <category>notice</category>
        
        <category>linux</category>
        
      </item>
    
      <item>
        <title>Мониторинг dmesg</title>
        <description>&lt;h3 id=&quot;section&quot;&gt;Задача&lt;/h3&gt;
&lt;p&gt;Необходимо организовать централизованный сбор логов, в частности сообщений ядра &lt;code class=&quot;highlighter-rouge&quot;&gt;dmesg&lt;/code&gt; и реакции на них со стороны событийного мониторинга (например &lt;em&gt;nagios&lt;/em&gt;).&lt;/p&gt;

&lt;h3 id=&quot;section-1&quot;&gt;Передача сообщений ядра на сервер логов&lt;/h3&gt;
&lt;p&gt;Для передачи сообщения ядра можно использовать модуль &lt;code class=&quot;highlighter-rouge&quot;&gt;netconsole&lt;/code&gt;. Он позволяет передавать сообщения журнала ядра (dmesg) на удаленный компьютер по сети, без участия пространства пользователя (например, syslogd).
Для сбора данных можно использовать, например &lt;a href=&quot;http://logstash.net/&quot;&gt;logstash&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Netconsole может быть встроен в ядро, так и загружен как модуль. Я использую загрузка модуля после загрузки системы, чтобы гарантировать, что сеть уже работает  настроена.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# dmesg -n 7
# modprobe netconsole netconsole=&quot;6665@10.13.77.99/eth1,6666@10.13.77.1/d4:ae:52:cf:33:96&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Первая команда устанавливает уровень логирования для &lt;code class=&quot;highlighter-rouge&quot;&gt;dmesg&lt;/code&gt;.
Вторая загружает модуль &lt;code class=&quot;highlighter-rouge&quot;&gt;netconsole&lt;/code&gt; с параметрами, где:
&lt;!--more--&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;6665 - порт отправки сообщений&lt;/li&gt;
  &lt;li&gt;10.13.77.99 - ip адрес хоста, с которого отправляются сообщения (текущий сервер)&lt;/li&gt;
  &lt;li&gt;eth1 - интерфейс с которого отправляются сообщения&lt;/li&gt;
  &lt;li&gt;6666 - порт, на который принимаются сообщения&lt;/li&gt;
  &lt;li&gt;10.13.77.1 - ip адрес хоста, на который принимаются сообщения&lt;/li&gt;
  &lt;li&gt;MAC - mac адрес интерфейса, на который принимаются сообщения&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Установка &lt;code class=&quot;highlighter-rouge&quot;&gt;logstash&lt;/code&gt; не является темой этой статьи, поэтому я буду показывать лишь части конфига необходимые для реализации задачи. Для получения сообщений от &lt;code class=&quot;highlighter-rouge&quot;&gt;netconsole&lt;/code&gt; надо указать следующий кусок конфига в блоке &lt;code class=&quot;highlighter-rouge&quot;&gt;input&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;input&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;udp&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;py&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;gt; &quot;netconsole&quot;&lt;/span&gt;
        &lt;span class=&quot;py&quot;&gt;port&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;gt; &quot;6666&quot;&lt;/span&gt;
        &lt;span class=&quot;py&quot;&gt;host&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&amp;gt; &quot;10.13.77.1&quot; }&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;где &lt;code class=&quot;highlighter-rouge&quot;&gt;host&lt;/code&gt; - это ip адрес интерфейса на который будут присылаться сообщения ядра.&lt;/p&gt;

&lt;p&gt;Теперь все сообщения ядра отправляются в &lt;code class=&quot;highlighter-rouge&quot;&gt;logstash&lt;/code&gt;.&lt;/p&gt;

&lt;h3 id=&quot;section-2&quot;&gt;Оповещения при критических сообщениях ядра&lt;/h3&gt;
&lt;p&gt;В моём случае я хочу отслеживать наличие OOM сообщений и рассылать оповещения об этом. &lt;code class=&quot;highlighter-rouge&quot;&gt;Logstash&lt;/code&gt; может отправлять письма с оповещениями сам, но мне интересно делать это событийным мониторингом.&lt;/p&gt;

&lt;p&gt;В качестве событийного мониторинга я использую &lt;a href=&quot;www.shinken-monitoring.org&quot;&gt;shinken&lt;/a&gt;. Для реализации оповещения админов, по моему, лучше использовать сервисные чеки &lt;code class=&quot;highlighter-rouge&quot;&gt;is_volatile&lt;/code&gt;. Эта опция позволяет отправлять оповещения на каждый статус non-OK даже если он не менялся. Подробнее об этой опции можно почитать &lt;a href=&quot;https://shinken.readthedocs.org/en/latest/07_advanced/volatileservices.html&quot;&gt;тут&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Чтобы не повторяться в описании каждого сервиса напишем template для volatile сервисов:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;define service {
  name                          volatile-service
  check_command                 dummy_ok
  max_check_attempts            1
  check_interval                5
  retry_interval                2
  active_checks_enabled         0
  passive_checks_enabled        1
  check_period                  24x7
  check_freshness               1
  freshness_threshold           300
  flap_detection_enabled        0
  notification_interval         60
  notification_period           24x7
  notification_options          u,c,w
  notifications_enabled         1
  contact_groups                sysadmin
  register                      0
}
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;В данном описании мы определяем пассивные сервисы, которые будут автоматически сбрасываться в статус ОК через 5 минут после изменения статуса. Так же важно в опции &lt;code class=&quot;highlighter-rouge&quot;&gt;max_check_attempts&lt;/code&gt; указать 1, чтобы сервис сразу после первого сообщения переходил в &lt;code class=&quot;highlighter-rouge&quot;&gt;hard-state&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Теперь можно описать сам сервис используя вышеописанный template:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;define service {
  hostgroup_name                linux
  service_description           log_event
  servicegroups                 logs
  initial_state                 o
  register                      1
  use                           volatile-service
}
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;С настройкой событийного мониторинга закончили. Переходим к настройке &lt;code class=&quot;highlighter-rouge&quot;&gt;logstash&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Т.к. все сообщения ядра приходят от IP адреса сервера, который его сгенерил, то первое что я рекомендую сделать это настроить для серверов обратную зону, что позволит упростить и дальнейшую работу с логами и передачу сообщений в &lt;em&gt;shinken&lt;/em&gt;. Если обратная зона есть, то можно добавить в блок &lt;em&gt;filter&lt;/em&gt; следующий кусок конфига:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;filter&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;...&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;dns&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;err&quot;&gt;&#39;action&#39;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;&quot;replace&quot;&lt;/span&gt;
            &lt;span class=&quot;err&quot;&gt;&#39;reverse&#39;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&quot;host&quot;]&lt;/span&gt;
            &lt;span class=&quot;err&quot;&gt;&#39;type&#39;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;&quot;netconsole&quot;&lt;/span&gt;
        &lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Теперь в поле &lt;code class=&quot;highlighter-rouge&quot;&gt;host&lt;/code&gt; вместо IP адреса сервера будет подставляться последний уровень домена хоста (т.е. если полный домен myserver.my.domain.example.com, то в поле попадёт только myserver). Это упростит жизнь в будущем.&lt;/p&gt;

&lt;p&gt;Далее добавим фильтрацию сообщений, на появления которых хотим получать оповещения. Для примера возьмём строку сообщающую о приходи &lt;em&gt;oom&lt;/em&gt; киллера и будем тагать записи такого типа:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    &lt;span class=&quot;err&quot;&gt;filter&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;err&quot;&gt;...&lt;/span&gt;
        &lt;span class=&quot;err&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[message]&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;=~&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;/.+Out.of.memory.+Kill.process.+/&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;{&lt;/span&gt;
           &lt;span class=&quot;err&quot;&gt;noop&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;{&lt;/span&gt;
                  &lt;span class=&quot;err&quot;&gt;&#39;add_tag&#39;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&quot;notify&quot;]&lt;/span&gt;
              &lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;err&quot;&gt;...&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Осталось научить &lt;em&gt;logstash&lt;/em&gt; отправлять сообщения с тэгом &lt;code class=&quot;highlighter-rouge&quot;&gt;notify&lt;/code&gt;. Для отправки на сервер &lt;em&gt;Nagios&lt;/em&gt; можно использовать уже готовые плагины &lt;em&gt;logstash&lt;/em&gt; &lt;a href=&quot;http://logstash.net/docs/1.4.2/outputs/nagios&quot;&gt;nagios&lt;/a&gt; или &lt;a href=&quot;http://logstash.net/docs/1.4.2/outputs/nagios&quot;&gt;nagios_nsca&lt;/a&gt;. Я использую &lt;em&gt;shinken&lt;/em&gt; и хоть он и совместим с &lt;em&gt;Nagios&lt;/em&gt; в большинстве случаев, в этом я предпочёл использовать API &lt;em&gt;shinken&lt;/em&gt;. Для отправки сообщений я написал простенький скрипт на &lt;code class=&quot;highlighter-rouge&quot;&gt;bash&lt;/code&gt;:&lt;/p&gt;

&lt;blockquote class=&quot;filename&quot;&gt;
  &lt;p&gt;log_event_sender.sh&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;
&lt;span class=&quot;c&quot;&gt;# WS_Arbiter config&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;USER&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;username;
&lt;span class=&quot;nv&quot;&gt;PASS&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;password;
&lt;span class=&quot;nv&quot;&gt;WS_IP&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;192.168.0.55;
&lt;span class=&quot;nv&quot;&gt;WS_PORT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;7760;

&lt;span class=&quot;nv&quot;&gt;HOST_NAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$1&lt;/span&gt;;
&lt;span class=&quot;nv&quot;&gt;SERVICE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$2&lt;/span&gt; | sed -r -e &lt;span class=&quot;s1&quot;&gt;&#39;s/[[:space:]]/%20/g&#39;&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;;
&lt;span class=&quot;nv&quot;&gt;RCODE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2;
&lt;span class=&quot;nv&quot;&gt;MESSAGE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$3&lt;/span&gt; | sed -r -e &lt;span class=&quot;s1&quot;&gt;&#39;s/[[:space:]]/%20/g&#39;&lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;;

&lt;span class=&quot;nv&quot;&gt;DATA&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;time_stamp=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;date +%s&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;amp;host_name=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$HOST_NAME&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;amp;service_description=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$SERVICE&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;amp;return_code=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$RCODE&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&amp;amp;output=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$MESSAGE&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;;
&lt;span class=&quot;nv&quot;&gt;SEND&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;curl -s -u &lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;USER&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;:&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;PASS&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt; -d &lt;span class=&quot;nv&quot;&gt;$DATA&lt;/span&gt; http://&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;WS_IP&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;:&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;WS_PORT&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;/push_check_result&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Добавляем отправку сообщений с тэгом &lt;code class=&quot;highlighter-rouge&quot;&gt;notify&lt;/code&gt; в конфиг &lt;em&gt;logstash&lt;/em&gt;:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;output&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;err&quot;&gt;exec&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;{&lt;/span&gt;
       &lt;span class=&quot;err&quot;&gt;&#39;tags&#39;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;[&quot;notify&quot;]&lt;/span&gt;
       &lt;span class=&quot;err&quot;&gt;&#39;command&#39;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;&quot;/usr/local/log_event_sender.sh&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;%{host}&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;log_event&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;&#39;%{message}&#39;&quot;&lt;/span&gt;
  &lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Дальнейшее расширение очевидно. Если нужно добавить оповещение о сообщениях другого типа, то нужно просто отлавливать их в &lt;em&gt;logstash&lt;/em&gt; и навешивать тэг &lt;code class=&quot;highlighter-rouge&quot;&gt;notify&lt;/code&gt;.&lt;/p&gt;
</description>
        <pubDate>Wed, 02 Jul 2014 09:58:00 +0300</pubDate>
        <link>https://cyberflow.net/monitoring/linux/2014/07/02/monitoring-dmesg.html</link>
        <guid isPermaLink="true">https://cyberflow.net/monitoring/linux/2014/07/02/monitoring-dmesg.html</guid>
        
        <category>monitoring</category>
        
        <category>dmesg</category>
        
        <category>oom</category>
        
        <category>logs</category>
        
        <category>logstash</category>
        
        <category>netconsole</category>
        
        <category>linux</category>
        
        <category>shinken</category>
        
        
        <category>monitoring</category>
        
        <category>linux</category>
        
      </item>
    
      <item>
        <title>Erchef no_connect Error</title>
        <description>&lt;h3 id=&quot;section&quot;&gt;Предпосылки&lt;/h3&gt;
&lt;p&gt;Столкнулся с тем, что при большом количестве нод в &lt;a href=&quot;http://opscode.com&quot;&gt;chef-server&lt;/a&gt; версий &lt;em&gt;11.0.4&lt;/em&gt; и &lt;em&gt;11.0.8&lt;/em&gt; поставленных из omnibus пакетов для Ubuntu, он с большой периодичностью стал отдавать &lt;code class=&quot;highlighter-rouge&quot;&gt;500 Internal server error&lt;/code&gt; нодам при выполнении куска рецепта, который делает поиск по data_bag’ам. При изучении логов выяснилось следующее:
В логах nginx’a видно, что запросы на поиск отправляются на бэкэнд erchef’а (ядро chef-server написанное на эрланге) и в ответ получаем &lt;code class=&quot;highlighter-rouge&quot;&gt;500&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;192.168.1.111 - - [27/May/2014:11:45:28 +0000] &quot;GET /search/databag1?q=id:node1&amp;amp;sort=X_CHEF_id_CHEF_X%20asc&amp;amp;start=0&amp;amp;rows=1000 HTTP/1.1&quot; 500 &quot;0.051&quot; 36 &quot;-&quot; &quot;Chef Client/11.6.0 (ruby-1.9.3-p429; ohai-6.18.0; x86_64-linux; +http://opscode.com)&quot; &quot;127.0.0.1:8000&quot; &quot;500&quot; &quot;0.046&quot; &quot;11.6.0&quot; &quot;algorithm=sha1;version=1.0;&quot; &quot;auth1&quot; &quot;2014-05-27T11:45:28Z&quot; &quot;2jmj7l5rSw0yVb/vlWAYkK/YBwk=&quot; 1011 
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Смотрим далее в логи &lt;code class=&quot;highlighter-rouge&quot;&gt;erchef&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;ERROR&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;REPORT&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;====&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;27&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;May&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2014&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;11&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;45&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;28&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;===&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;webmachine&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;path&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;/search/databag1&quot;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;function_clause&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;chef_wm_search&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;&#39;-make_bulk_get_fun/5-lc$^1/1-2-&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
             &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;no_connections&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
             &lt;span class=&quot;o&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;databag1&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt;
             &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;src/chef_wm_search.erl&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;233&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]},&lt;/span&gt;
         &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;chef_wm_search&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fetch_result_rows&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
             &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;src/chef_wm_search.erl&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;351&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]},&lt;/span&gt;
         &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;chef_wm_search&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;make_search_results&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
             &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;src/chef_wm_search.erl&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;324&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]},&lt;/span&gt;
         &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;chef_wm_search&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;to_json&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
             &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;src/chef_wm_search.erl&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;130&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]},&lt;/span&gt;
         &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;webmachine_resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resource_call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
             &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;src/webmachine_resource.erl&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;166&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]},&lt;/span&gt;
         &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;webmachine_resource&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;do&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
             &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;src/webmachine_resource.erl&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;125&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]},&lt;/span&gt;
         &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;webmachine_decision_core&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;resource_call&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
             &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;src/webmachine_decision_core.erl&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;48&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]},&lt;/span&gt;
         &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;webmachine_decision_core&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;decision&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
             &lt;span class=&quot;p&quot;&gt;[{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;src/webmachine_decision_core.erl&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;532&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}]}]}}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;К сожалению то, что erchef пишет в свой лог не информативно. Однако путём длительного перебора удалось понять, что проблема в соединении к базе.&lt;/p&gt;

&lt;!--more--&gt;

&lt;h3 id=&quot;section-1&quot;&gt;Решение&lt;/h3&gt;
&lt;p&gt;Суть проблемы в том, что erchef открывает &lt;em&gt;N&lt;/em&gt; соединений к базе &lt;em&gt;postgresql&lt;/em&gt; (по умолчанию 20) и вываливается с выше указанной ошибкой, если этих 20-и соединений ему не хватает.
Чтобы увеличить количество соединений нужно поправить конфиг erchef’a.&lt;/p&gt;

&lt;blockquote class=&quot;filename&quot;&gt;
  &lt;p&gt;/var/opt/chef-server/erchef/etc/app.config&lt;/p&gt;
&lt;/blockquote&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pooler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
           &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pools&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[[{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;sqerl&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
                     &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;max_count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;60&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
                     &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;init_count&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;40&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
                     &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;start_mfa&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sqerl_client&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;start_link&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]}}]]},&lt;/span&gt;
           &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;metrics_module&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;folsom_metrics&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
          &lt;span class=&quot;p&quot;&gt;]},&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Правим значения для &lt;code class=&quot;highlighter-rouge&quot;&gt;max_count&lt;/code&gt; и &lt;code class=&quot;highlighter-rouge&quot;&gt;init_count&lt;/code&gt; с 20 на большие. В моём случае пока хватает 60 и 40.&lt;/p&gt;
</description>
        <pubDate>Wed, 28 May 2014 09:42:00 +0300</pubDate>
        <link>https://cyberflow.net/chef/2014/05/28/erchef-no-connect-error.html</link>
        <guid isPermaLink="true">https://cyberflow.net/chef/2014/05/28/erchef-no-connect-error.html</guid>
        
        <category>chef</category>
        
        <category>chef-server</category>
        
        <category>erchef</category>
        
        <category>error</category>
        
        <category>no_connections</category>
        
        
        <category>chef</category>
        
      </item>
    
      <item>
        <title>Трюки с ssh config</title>
        <description>&lt;p&gt;Конфиг ssh очень полезная и удобная штука. Пользуюсь им давно, но недавно открыл ещё несколько замечательных возможностей. Решил поделиться парой полезных фич и рассказать об одном маленьком лайфхаке.&lt;/p&gt;

&lt;h3 id=&quot;section&quot;&gt;Шаринг соединений&lt;/h3&gt;
&lt;p&gt;Часто бывает необходимо по работе держать много консолей с ssh на один сервер. Для упрощения такой работы (с точки зрения компьютера) в OpenSSH есть возможность шарить соединения. Т.е. если вы зашли на сервер, то в системе создается &lt;em&gt;ControlSocket&lt;/em&gt; и все последующие соединения на этот сервер будут использовать уже созданный сокет, а не создавать новое подключение. И если при первом соединении сервер спрашивает у вас пароль, то при повторном использовании уже сокета авторизация не потребуется.&lt;/p&gt;

&lt;p&gt;Для настройки &lt;em&gt;Connection sharing&lt;/em&gt; необходимо добавить следующие строчки в начало конфига ssh:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ControlMaster auto
ControlPath /tmp/ssh_%h_%p_%r
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;section-1&quot;&gt;Проброс соединений через сервер&lt;/h3&gt;
&lt;p&gt;Другая не менее полезная штука - это возможность настроить соединение через сервер. Т.е. вместо двух команд: &lt;code class=&quot;highlighter-rouge&quot;&gt;ssh server1&lt;/code&gt; и потом уже оттуда &lt;code class=&quot;highlighter-rouge&quot;&gt;ssh server2&lt;/code&gt;, можно сразу в конфиге всё прописать и ходить одной командой.&lt;/p&gt;

&lt;!--more--&gt;

&lt;p&gt;Выглядеть такой конфиг будет примерно так:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Host server2
    HostName server2.domain.org
    ProxyCommand ssh -W %h:%p -C server1
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Тут стоит пояснить, что ssh подставит вместо &lt;code class=&quot;highlighter-rouge&quot;&gt;%h&lt;/code&gt; хост, а вместо &lt;code class=&quot;highlighter-rouge&quot;&gt;%p&lt;/code&gt; порт.&lt;/p&gt;

&lt;p&gt;Но и это ещё не всё. Помимо это ssh понимает паттерны внутри своего конфига.
Приведу пример:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Host db*
   ProxyCommand ssh -W %h:%p -C gateway
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Теперь мы можем одной командой, скажем &lt;code class=&quot;highlighter-rouge&quot;&gt;ssh db2.domain.org&lt;/code&gt; попасть на сервер пробросив соединение через другой.&lt;/p&gt;

&lt;p&gt;Этот метод в сочетании с шарингом соединений даёт мощный инструмент.&lt;/p&gt;

&lt;h3 id=&quot;section-2&quot;&gt;Проброс соединений для серверов с похожими именами&lt;/h3&gt;
&lt;p&gt;А теперь о проблеме с которой я столкнулся и “героически” решил.
ПРоблема была в том, что есть два набора серверов с одинаковыми именами, пусть для примера это будут &lt;em&gt;db1&lt;/em&gt; &lt;em&gt;db2&lt;/em&gt; &lt;em&gt;dbN&lt;/em&gt;, находящихся за разными серверами, через которые на них надо ходить, пусть это будет &lt;em&gt;gate1&lt;/em&gt; и &lt;em&gt;gate2&lt;/em&gt;. Предыдущий пример с использованием паттернов покрывает задачу лишь частично. Можно, конечно, выкрутиться используя паттерны с доменным именем, но в таком случае надо набирать полное доменное имя сервера, хотя с гейта на него можно попасть по короткому имени без домена.
Решить эту проблему удалось с помощью использования факта, что &lt;code class=&quot;highlighter-rouge&quot;&gt;ProxyCommand&lt;/code&gt; интерпретируется bash’ем =)
В итоге конфиг выглядит приблизительно так:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Host db*.dc1
    ProxyCommand ssh -W $(echo %h| cut -d. -f1):%p -C gate1

Host db*.dc2
    ProxyCommand ssh -W $(echo %h| cut -d. -f1):%p -C gate2
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Т.е. в консоле мы вводим &lt;code class=&quot;highlighter-rouge&quot;&gt;ssh db5.dc2&lt;/code&gt;, данный сервер матчится со вторым паттерном, но пре передачи имени хоста в прокси-команду ненужная часть домена отбрасывается.&lt;/p&gt;

&lt;p&gt;Больше о конфиге ssh можно узнать из документации: &lt;a href=&quot;http://man.cx/ssh_config&quot;&gt;ssh_config&lt;/a&gt;&lt;/p&gt;
</description>
        <pubDate>Thu, 22 May 2014 20:57:00 +0300</pubDate>
        <link>https://cyberflow.net/linux/2014/05/22/ssh-config-tricks.html</link>
        <guid isPermaLink="true">https://cyberflow.net/linux/2014/05/22/ssh-config-tricks.html</guid>
        
        <category>linux</category>
        
        <category>ssh_config</category>
        
        <category>openssh</category>
        
        <category>ssh</category>
        
        
        <category>linux</category>
        
      </item>
    
      <item>
        <title>Установка slave mysql-percona сервера</title>
        <description>&lt;p&gt;Хочу сразу заметить, что способов развернуть slave сервер существует масса. Я хочу рассказать лишь об одном из них. Во-первых для себя, т.к. я часто применяю его в работе. Во-вторых для тех, у кого стоит задача по развертыванию независимого (поясню: это значит что перенос файлов базы с одного сервера на другой не подходит, как в моём случае. Т.е. репликация не полная) slave и при этом репликация производиться только над некоторыми БД, а не над всем, что есть.&lt;/p&gt;

&lt;p&gt;Подразумевается, что уже есть мастер сервер, на котором крутятся БД и настроен для репликации.&lt;/p&gt;

&lt;p&gt;Теперь надо сделать dump баз данных, при этом будем использовать атрибуты &lt;code class=&quot;highlighter-rouge&quot;&gt;add-drop-database&lt;/code&gt; для добавление в dump строчки удаляющей базу перед её созданием и &lt;code class=&quot;highlighter-rouge&quot;&gt;master-data&lt;/code&gt; для добавления информации о бин-логах и их позиции на момент создания dump’a. Так же, чтобы избежать переноса служебных баз, формируем список баз для переноса исключив из них все служебные базы mysql (в список можно добавить и другие базы по аналогии). После создания dump’a переносим его на slave сервер.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# DATABASE_LIST=$(mysql -NBe &#39;show schemas&#39; | grep -wv &#39;mysql\|performance_schema\|information_schema&#39;)
# mysqldump  --databases $DATABASE_LIST --add-drop-database --master-data -u root -p &amp;gt; dbdump.db
# scp dbdump.db mysql-slave-host:~/
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;На slave сервере добавляем необходиму информацию для репликации. Это можно сделать и после развертывания dump’a. Так же я пропущу описание настройки репликации в конфигурации mysql.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# mysql
mysql&amp;gt; CHANGE MASTER TO MASTER_HOST=&#39;mysql-master-host&#39;, MASTER_USER=&#39;$replica_user&#39;, MASTER_PASSWORD=&#39;$slavepass&#39;;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;Теперь можно залить сделанный dump и после этого включить репликацию.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# mysql -p &amp;lt; ~/dbdump.db
# mysql
mysql&amp;gt; slave start;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

</description>
        <pubDate>Wed, 14 May 2014 18:03:00 +0300</pubDate>
        <link>https://cyberflow.net/ha/linux/databases/2014/05/14/install-slave-percona-server.html</link>
        <guid isPermaLink="true">https://cyberflow.net/ha/linux/databases/2014/05/14/install-slave-percona-server.html</guid>
        
        <category>linux</category>
        
        <category>mysql</category>
        
        <category>replication</category>
        
        <category>ha</category>
        
        
        <category>ha</category>
        
        <category>linux</category>
        
        <category>databases</category>
        
      </item>
    
      <item>
        <title>Репликация таблиц базы chef-server </title>
        <description>&lt;h3 id=&quot;intro&quot;&gt;Intro&lt;/h3&gt;
&lt;p&gt;В данной статье я расскажу как настроить два сервера &lt;a href=&quot;http://www.opscode.com&quot; title=&quot;Opscode&quot;&gt;chef-server&lt;/a&gt; версии 11 с репликацией части таблиц базы postgresql для обеспечения отказоустойчивости. Основная цель репликации это хранения данных о клиентах и нодах для прозрачного доступа нод к любому из &lt;a href=&quot;http://www.opscode.com&quot; title=&quot;Opscode&quot;&gt;chef&lt;/a&gt; серверов и возможности работы без перерегистрации. Предлагаемое &lt;a href=&quot;http://www.opscode.com&quot; title=&quot;Opscode&quot;&gt;opscode&lt;/a&gt; решение репликации данных через DRBD показалось мне не самым удобным и, главное, надёжным. По сему было принято решение искать альтернативные пути. Так как реплицировать все данные из всех таблиц нет необходимости, то было решено посмотреть в сторону &lt;a href=&quot;http://wiki.postgresql.org/wiki/Skytools&quot;&gt;skytools&lt;/a&gt; и &lt;a href=&quot;http://wiki.postgresql.org/wiki/Skytools#Londiste&quot;&gt;londiste&lt;/a&gt;, которые позволяют реплицировать только определенные таблицы БД.&lt;/p&gt;

&lt;p&gt;Однако не обошлось без сюрпризов. &lt;a href=&quot;http://www.opscode.com&quot; title=&quot;Opscode&quot;&gt;Opscode&lt;/a&gt; распространяет shef-server 11 по средствам уже собранных omnibus пакетов, в котором свой postgres 9.2. Этот постгрес собран урезанным и не работает с skytools. В итоге в этой статье будет описано как поставить chef-server из omnibus пакета на дистрибутивный postgres 9.2 и прикрутить репликацию через londiste.&lt;/p&gt;

&lt;!--more--&gt;

&lt;p&gt;Мы будем устанавливать всё на &lt;a href=&quot;http://debian.org&quot;&gt;debian 7&lt;/a&gt;. Будет 2 сервера: &lt;code class=&quot;highlighter-rouge&quot;&gt;chef-master&lt;/code&gt; и &lt;code class=&quot;highlighter-rouge&quot;&gt;chef-slave&lt;/code&gt; соответственно.&lt;/p&gt;

&lt;h3 id=&quot;postgresql-92&quot;&gt;Добавление репозитория; Установка postgresql 9.2&lt;/h3&gt;
&lt;p&gt;К сожалению в дистрибутивном репозитории debian нет postgresql 9.2. По этому будем использовать не родной.
Добавляем репозиторий для установки postgres-a и skytools и устанавливаем на обоих серверах:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-console&quot; data-lang=&quot;console&quot;&gt;root@chef-master:~# wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
root@chef-master:~# echo &quot;deb http://apt.postgresql.org/pub/repos/apt/ wheezy-pgdg main&quot; &amp;gt; /etc/apt/sources.list.d/postgresql.list
root@chef-master:~# aptitude update
root@chef-master:~# aptitude install skytools-modules-9.2 skytools3 skytools3-ticker skytools3-walmgr&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;!-- more --&gt;

&lt;h3 id=&quot;chef-server--&quot;&gt;Установка chef-server на мастер&lt;/h3&gt;
&lt;p&gt;Теперь можно начинать устанавливать chef-server:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-console&quot; data-lang=&quot;console&quot;&gt;root@chef-master:~# wget https://opscode-omnibus-packages.s3.amazonaws.com/ubuntu/11.04/x86_64/chef-server_11.0.4-1.ubuntu.11.04_amd64.deb
root@chef-master:~# dpkg -i chef-server_11.0.4-1.ubuntu.11.04_amd64.deb&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Перед запуском &lt;code class=&quot;highlighter-rouge&quot;&gt;chef-server-ctl reconfigure&lt;/code&gt; нужно немного поправить chef-solo рецепт для postgresql из omnibus пакета. Надо заменить исходный рецепт &lt;code class=&quot;highlighter-rouge&quot;&gt;/opt/chef-server/embedded/cookbooks/chef-server/recipes/postgresql.rb&lt;/code&gt; на не исходный - &lt;a href=&quot;/files/postgresql.rb&quot;&gt;postgresql.rb&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Запускаем &lt;code class=&quot;highlighter-rouge&quot;&gt;sudo chef-server-ctl reconfigure&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Собственно после этих действий получаем chef-server на дистрибутивном postgresql 9.2, что уже не плохо. Далее надо повторить эту же операцию на втором сервере(chef-slave).&lt;/p&gt;

&lt;h3 id=&quot;chef-server---&quot;&gt;Установка chef-server; Подготовка к репликации&lt;/h3&gt;
&lt;p&gt;Процедура идентична за исключение нескольких дополнительных шагов.
Необходимо настроить postgres на IP адресе, который позволит мастеру производить репликацию и добавить в &lt;code class=&quot;highlighter-rouge&quot;&gt;pg_hba.conf&lt;/code&gt; разрешение для мастера.&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@chef-slave:~# sed -i &quot;s/#listen_addresses = &#39;localhost&#39;/listen_addresses = &#39;*&#39;/&quot; /etc/postgresql/9.2/mainpostgresql.conf
root@chef-slave:~# echo &quot;host all all &amp;lt;chef-master-ip&amp;gt;/32 trust&quot; &amp;gt;&amp;gt; /etc/postgresql/9.2/main/pg_hba.conf
root@chef-slave:~# service postgresql restart
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Далее надо почистить текущую базу от данных:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@chef-slave:~# su postgres -c &quot;psql -d &#39;opscode_chef&#39; -c \&quot;delete from clients; \&quot;&quot;
root@chef-slave:~# su postgres -c &quot;psql -d &#39;opscode_chef&#39; -c \&quot;delete from osc_users; \&quot;&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Ещё надо подменить содержимое директории &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/chef-server&lt;/code&gt; на сервер &lt;code class=&quot;highlighter-rouge&quot;&gt;chef-slave&lt;/code&gt; на содержимое той же директории с сервер &lt;code class=&quot;highlighter-rouge&quot;&gt;chef-master&lt;/code&gt;. Там хранятся приватные ключи от системных пользователей chef-server-a.&lt;/p&gt;

&lt;p&gt;Теперь всё готово к запуску репликации.&lt;/p&gt;

&lt;h3 id=&quot;section&quot;&gt;Настройка репликации&lt;/h3&gt;
&lt;p&gt;Для начала нужно добавить londiste и pgq в нашу базу. Для этого воспользуемся утилитой qadmin, которая была добавлена в skytools3:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-console&quot; data-lang=&quot;console&quot;&gt;root@chef-master:~# su postgres -c &quot;qadmin -h localhost -U postgres -d opscode_chef -c &#39;install londiste&#39;&quot;
INSTALL&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Пишем конфиги для мастера и слейва(оба конфига лежат на chef-master):&lt;/p&gt;

&lt;blockquote class=&quot;filename&quot;&gt;
  &lt;p&gt;/etc/skytools/replication_master.ini&lt;/p&gt;
&lt;/blockquote&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-cfg&quot; data-lang=&quot;cfg&quot;&gt;[londiste3]
job_name = replication_src
db = host=master-db dbname=opscode_chef user=postgres
queue_name = replica
logfile = /var/log/skytools/replica_src.log
pidfile = /var/run/skytools/replica_src.pid &lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Добавляем мастер:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-console&quot; data-lang=&quot;console&quot;&gt;root@chef-master:~# londiste3 /etc/skytools/replication_master.ini create-root master-server &#39;dbname=opscode_chef user=postgres&#39;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Конфиг для слейва:&lt;/p&gt;

&lt;blockquote class=&quot;filename&quot;&gt;
  &lt;p&gt;/etc/skytools/replication_slave.ini&lt;/p&gt;
&lt;/blockquote&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-cfg&quot; data-lang=&quot;cfg&quot;&gt;[londiste3]
job_name = replication_dst
db = host=master-db dbname=opscode_chef user=postgres
queue_name = replica
logfile = /var/log/skytools/replica_dst.log
pidfile = /var/run/skytools/replica_dst.pid &lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Добавление слейва:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-console&quot; data-lang=&quot;console&quot;&gt;root@chef-master:~# londiste3 /etc/skytools/replication_slave.ini create-leaf slave-server &#39;dbname=opscode_chef host=chef-slave user=postgres&#39; --provider=&#39;host=localhost dbname=opscode_chef user=postgres&#39; &lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Добавляем конфиг для pgq демона:&lt;/p&gt;

&lt;blockquote class=&quot;filename&quot;&gt;
  &lt;p&gt;/etc/skytools/pgqd.ini&lt;/p&gt;
&lt;/blockquote&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-cgf&quot; data-lang=&quot;cgf&quot;&gt;[pgqd]
logfile = /var/log/skytools/pgqd.log
pidfile = /var/run/skytools/pgqd.pid
base_connstr = host=localhost user=postgres
initial_database = opscode_chef&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Теперь запускаем skytools и проверяем, что всё настроено верно:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@chef-master:~# service skytools start
root@chef-master:~# londiste3 /etc/skytools/replication_master.ini status
Queue: replica   Local node: master-server

master-server (root)
  |                           Tables: 0/0/0
  |                           Lag: 12s, Tick: 32
  +--slave-server (leaf)
                              Tables: 0/0/0
                              Lag: 12s, Tick: 32
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Видим, что у нас есть 2 сервера но пока ничего не реплицируется.
Добавляем необходимые таблицы:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@chef-master:~# londiste3 /etc/skytools/replication_master.ini add-table clients
root@chef-master:~# londiste3 /etc/skytools/replication_master.ini add-table nodes
root@chef-master:~# londiste3 /etc/skytools/replication_master.ini add-table osc_users
root@chef-master:~# londiste3 /etc/skytools/replication_slave.ini add-table nodes
root@chef-master:~# londiste3 /etc/skytools/replication_slave.ini add-table clients
root@chef-master:~# londiste3 /etc/skytools/replication_slave.ini add-table osc_users
root@chef-master:~# londiste3 /etc/skytools/replication_master.ini status
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Спустя несколько минут мы можем увидеть, что репликация завершилась:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Queue: replica   Local node: master-server

master-server (root)
  |                           Tables: 3/0/0
  |                           Lag: 14s, Tick: 52
  +--slave-server (leaf)
                              Tables: 3/0/0
                              Lag: 14s, Tick: 52
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

</description>
        <pubDate>Fri, 09 Aug 2013 11:16:00 +0300</pubDate>
        <link>https://cyberflow.net/chef/ha/linux/2013/08/09/replication-chef-database.html</link>
        <guid isPermaLink="true">https://cyberflow.net/chef/ha/linux/2013/08/09/replication-chef-database.html</guid>
        
        <category>debian</category>
        
        <category>postgresql</category>
        
        <category>skytools</category>
        
        <category>replication</category>
        
        <category>chef</category>
        
        
        <category>chef</category>
        
        <category>ha</category>
        
        <category>linux</category>
        
      </item>
    
      <item>
        <title>logstash, ротация логов в elasticsearch</title>
        <description>&lt;p&gt;Небольшая заметка как организовать ротацию логов, собирающихся при помощи &lt;a href=&quot;http://logstash.net/&quot;&gt;logstash&lt;/a&gt; в &lt;a href=&quot;http://www.elasticsearch.org/&quot;&gt;elasticsearch&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;В крон добавляем:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;cat &lt;span class=&quot;sh&quot;&gt;&amp;lt;&amp;lt;&#39;EOF&#39; &amp;gt; /etc/cron.daily/logstash
#!/bin/bash
logdate=$(date -d&#39;-15 days&#39; +&quot;%Y.%m.%d&quot;)
curl -XDELETE &quot;http://localhost:9200/logstash-${logdate}&quot;
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;EOF&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Этот скрипт будет запускаться ежедневно и удалять все логи из elasticsearch 15-дневной давности.&lt;/p&gt;
</description>
        <pubDate>Fri, 31 May 2013 19:24:00 +0300</pubDate>
        <link>https://cyberflow.net/notice/linux/2013/05/31/logstash-rotate-logs-in-elasticsearch.html</link>
        <guid isPermaLink="true">https://cyberflow.net/notice/linux/2013/05/31/logstash-rotate-logs-in-elasticsearch.html</guid>
        
        <category>logstash</category>
        
        <category>logs</category>
        
        <category>elasticsearch</category>
        
        
        <category>notice</category>
        
        <category>linux</category>
        
      </item>
    
      <item>
        <title>Hyperdb to Wordpress</title>
        <description>&lt;p&gt;&lt;a href=&quot;http://wordpress.org/extend/plugins/hyperdb/&quot;&gt;Hyperdb&lt;/a&gt; - это замена стандартоного класса &lt;code class=&quot;highlighter-rouge&quot;&gt;wpdb&lt;/code&gt;, позволяющая использовать несколько баз данных.
В данной статье я опишу настройку hyperdb для распределенной инфраструктуры, состоящей из двух frontend серверов и двух серверов баз данных на базе дистрибутивов Debian 6, в качестве основной задачи ставилось не только распределение запросов на чтение между серверами БД, но и отслеживания отставаний слэйв сервера и, в случае отставания, чтение актуальных данных с мастера.&lt;/p&gt;

&lt;p&gt;Настройка самих фронтендов оставим за кадром, т.к. это выходит за рамки данной статьи. Что касается серверов БД, то мы будем использовать мастер-слэйв репликацию и mk-heartbeat для отслеживания lag-ов на слэйве. Сервера геораспределены и каждый сервер БД располагается в отдельном ДЦ в паре с фронтендом. На настройке баз я остановлючь подробнее:&lt;/p&gt;

&lt;h2 id=&quot;db&quot;&gt;Настройка репликации DB:&lt;/h2&gt;

&lt;p&gt;Здесь не описано ничего принципиально нового. Используется стандартная &lt;a href=&quot;http://dev.mysql.com/doc/refman/5.1/en/replication.html&quot;&gt;репликация Мастер-Слэйв&lt;/a&gt; средствами MySql.&lt;/p&gt;

&lt;!--more--&gt;

&lt;p&gt;Все, описанные ниже команды выполнялись под пользователем &lt;code class=&quot;highlighter-rouge&quot;&gt;root&lt;/code&gt;, что является не безопасным. Будьте осторожны, при работе под суперпользователем.&lt;/p&gt;

&lt;p&gt;Устанавливаем сервер баз данных и пакет с &lt;code class=&quot;highlighter-rouge&quot;&gt;mk-hertbeat&lt;/code&gt;:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-console&quot; data-lang=&quot;console&quot;&gt;# aptitude install mysql-server maatkit&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Далее, используя документацию создаём базу wordpress на db1.
Этот сервер будет мастером. В файл &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/mysql/my.cnf&lt;/code&gt; в секции [mysqld] необходимо добавить:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-cfg&quot; data-lang=&quot;cfg&quot;&gt;init-connect=&#39;SET NAMES utf8;&#39;
server-id                = 1
log_bin                  = /var/log/mysql/mysql-bin
expire_logs_days         = 5
max_binlog_size          = 100M
binlog_do_db             = wordpress&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Далее надо перезапустить mysql:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-console&quot; data-lang=&quot;console&quot;&gt;# service mysql restart&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Теперь блокируем базу на запись, чтобы избежать рассинхронизации до окончания настройки репликации:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-console&quot; data-lang=&quot;console&quot;&gt;mysql&amp;gt; FLUSH TABLES WITH READ LOCK;
mysql&amp;gt; SET GLOBAL read_only = ON;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;После этого делаем дамп базы wordpress и копируем на слэйв сервер БД (db2).&lt;/p&gt;

&lt;p&gt;На db1 создаём пользователя для репликации:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-console&quot; data-lang=&quot;console&quot;&gt;mysql&amp;gt; GRANT REPLICATION SLAVE, REPLICATION CLIENT ON wordpress.* TO repl@&#39;%&#39; IDENTIFIED BY &#39;replicationsuperpassword&#39; with grant option;
mysql&amp;gt; SHOW MASTER STATUS;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Из вывода последней команды нам понадобится &lt;code class=&quot;highlighter-rouge&quot;&gt;Position&lt;/code&gt; и &lt;code class=&quot;highlighter-rouge&quot;&gt;File&lt;/code&gt; для конфигурации репликации на втором сервере БД.
На втором сервере(db2) в &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/mysql/my.cnf&lt;/code&gt; в секции [mysqld] необходимо добавить:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-cfg&quot; data-lang=&quot;cfg&quot;&gt;server-id                = 2&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;На db2 выполняем следующие команды подставляя значения из вывода &lt;code class=&quot;highlighter-rouge&quot;&gt;SHOW MASTER STATUS&lt;/code&gt; c db1:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-console&quot; data-lang=&quot;console&quot;&gt;mysql&amp;gt; STOP SLAVE;
mysql&amp;gt; RESET SLAVE;
mysql&amp;gt; CHANGE MASTER TO MASTER_HOST=&#39;db1.host.ru&#39;,
MASTER_PORT=3306,
MASTER_USER=&#39;repl&#39;,
MASTER_PASSWORD=&#39;replicationsuperpassword&#39;,
MASTER_LOG_FILE=&#39;mysql-bin.000001&#39;,
MASTER_LOG_POS=106,
MASTER_CONNECT_RETRY=10;
mysql&amp;gt; START SLAVE;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Проверяем, что репликация работает:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-console&quot; data-lang=&quot;console&quot;&gt;mysql&amp;gt; SHOW SLAVE STATUS\G&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;В выводе должно присутствовать:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-cfg&quot; data-lang=&quot;cfg&quot;&gt;Slave_IO_Running: Yes
Slave_SQL_Running: Yes&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Если видим эти строки, то можно включать мастер БД(db1) на чтение:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-console&quot; data-lang=&quot;console&quot;&gt;mysql&amp;gt; SET GLOBAL read_only = OFF;
mysql&amp;gt; UNLOCK TABLES;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Переходим к настройке Hyperdb.&lt;/p&gt;

&lt;h2 id=&quot;hyperdb&quot;&gt;Установка и настройка Hyperdb:&lt;/h2&gt;
&lt;p&gt;Сама установка класса проста и не затейлива.
Скачиваем архивчик с классами с официального сайта &lt;a href=&quot;http://wordpress.org/extend/plugins/hyperdb/&quot;&gt;Wordpress&lt;/a&gt;. Распаковываем на всех web-серверах. В архиве всего 3 файла: &lt;code class=&quot;highlighter-rouge&quot;&gt;db-config.php&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;db.php&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;readme.txt&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Правим конфигурационный файл для web1 (он находится в том же сегменте, что и db1, т.е. рядом с мастером):&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ruby&quot; data-lang=&quot;ruby&quot;&gt;&lt;span class=&quot;sr&quot;&gt;//&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;описываем&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;параметры&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;подключения&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;к&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;мастеру&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;nf&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;Т&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;к&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;он&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;ближе&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;всех&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;то&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;и&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;читать&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;будем&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;с&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;него&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;ставим&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;приоритет&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;чтения&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;vg&quot;&gt;$wpdb&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;add_database&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;host&#39;&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;db1.hostname.ru&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;user&#39;&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;wordpress&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;password&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;wordpressdbpass&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;name&#39;&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;wordpress&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;write&#39;&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;read&#39;&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;

&lt;span class=&quot;sr&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;добавляем&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;слэйв&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;сервер&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;Т&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;к&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;он&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;в&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;другом&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;сегменте&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;то&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;приоритет&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;на&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;чтение&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;ниже&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;vg&quot;&gt;$wpdb&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;add_database&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;host&#39;&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;db2.hostname.ru&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;user&#39;&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;wordpress&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;password&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;wordpressdbpass&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;name&#39;&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;wordpress&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;write&#39;&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;read&#39;&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Такая конфигурация позволит читать с ближайшего сервера или со слейва, если мастер будет не доступен.
Конфиг для web2:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ruby&quot; data-lang=&quot;ruby&quot;&gt;&lt;span class=&quot;sr&quot;&gt;//&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;описываем&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;параметры&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;подключения&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;к&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;мастеру&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;nf&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;Пишем&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;мы&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;всегда&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;и&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;только&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;на&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;мастер&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;читать&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;с&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;него&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;будем&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;только&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;в&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;случае&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;отказа&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;слэйва&lt;/span&gt;
&lt;span class=&quot;sr&quot;&gt;//&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;ставим&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;приоритет&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;чтения&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;vg&quot;&gt;$wpdb&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;add_database&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;host&#39;&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;db1.hostname.ru&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;user&#39;&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;wordpress&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;password&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;wordpressdbpass&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;name&#39;&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;wordpress&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;write&#39;&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;read&#39;&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;

&lt;span class=&quot;sr&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;добавляем&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;слэйв&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;сервер&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;Т&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;к&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;он&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;рядом&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;то&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;приоритет&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;на&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;чтение&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;
&lt;span class=&quot;vg&quot;&gt;$wpdb&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;add_database&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;array&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;host&#39;&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;db2.hostname.ru&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;user&#39;&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;wordpress&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;password&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;wordpressdbpass&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;name&#39;&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&#39;wordpress&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;write&#39;&lt;/span&gt;    &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;read&#39;&lt;/span&gt;     &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
 &lt;span class=&quot;s1&quot;&gt;&#39;lag_threshold&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;60&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;sr&quot;&gt;//&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;определяем&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;допустимое&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;время&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;отставания&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;слэйва&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;в&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;секундах&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Теперь, если скопировать конфиги в корень wordpress, а &lt;code class=&quot;highlighter-rouge&quot;&gt;db.php&lt;/code&gt; в директорию &lt;code class=&quot;highlighter-rouge&quot;&gt;/wp-content/&lt;/code&gt;, то мы уже начнём работать с БД по распределенной схеме.&lt;/p&gt;

&lt;p&gt;Но цель данной статьи не просто распределять запросы на чтение по разным БД, но и реагировать на отставание слэйв-сервера, чтобы отдавать посетителям максимально актуальные данные.&lt;/p&gt;

&lt;h2 id=&quot;hyperdb-1&quot;&gt;Настройка обнаружения отсутствия слейва для hyperdb:&lt;/h2&gt;

&lt;p&gt;Первое что хочу отметить, что настраивать обнаружение лагов мы будем только для web2, т.к. web1 ходит читать в мастер, а в слэйв только по крайней необходимости и в таком случае лучше читать хоть что-то, чем вообще не вернуть никаких данных, хоть бы и не актуальных.&lt;/p&gt;

&lt;p&gt;В конфиге &lt;code class=&quot;highlighter-rouge&quot;&gt;db-config.php&lt;/code&gt; уже есть пример функций, позволяющих отслеживать лаги слэйва. Я лишь немного опишу процесс и как настроить сервера БД, чтобы эти функции работали и работали правильно. Для наглядности сразу приведу эти функции, которые нам надо будет добавить в конец файла &lt;code class=&quot;highlighter-rouge&quot;&gt;db-config.php&lt;/code&gt; на web2:&lt;/p&gt;

&lt;blockquote class=&quot;filename&quot;&gt;
  &lt;p&gt;db-config.php&lt;/p&gt;
&lt;/blockquote&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-php&quot; data-lang=&quot;php&quot;&gt;$wpdb-&amp;gt;lag_cache_ttl = 30;
$wpdb-&amp;gt;shmem_key = ftok( __FILE__, &quot;Y&quot; );
$wpdb-&amp;gt;shmem_size = 128 * 1024;

$wpdb-&amp;gt;add_callback( &#39;get_lag_cache&#39;, &#39;get_lag_cache&#39; );
$wpdb-&amp;gt;add_callback( &#39;get_lag&#39;,       &#39;get_lag&#39; );

function get_lag_cache( $wpdb ) {
 $segment = shm_attach( $wpdb-&amp;gt;shmem_key, $wpdb-&amp;gt;shmem_size, 0600 );
 $lag_data = @shm_get_var( $segment, 0 );
 shm_detach( $segment );

 if ( !is_array( $lag_data ) || !is_array( $lag_data[ $wpdb-&amp;gt;lag_cache_key ] ) )
  return false;

 if ( $wpdb-&amp;gt;lag_cache_ttl &lt;span class=&quot;nt&quot;&gt;&amp;lt; time&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;lag_data&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;$&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;wpdb-&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;lag_cache_key ][ &#39;timestamp&#39; ] )
  return false;

 return $lag_data[ $wpdb-&amp;gt;lag_cache_key ][ &#39;lag&#39; ];
}

function get_lag( $wpdb ) {
 $dbh = $wpdb-&amp;gt;dbhs[ $wpdb-&amp;gt;dbhname ];

 if ( !mysql_select_db( &#39;wordpress&#39;, $dbh ) ) // вот здесь мы поменяем имя базы на wordpress. Остальное как в примере.
  return false;

 $result = mysql_query( &quot;SELECT UNIX_TIMESTAMP() - UNIX_TIMESTAMP(ts) AS lag FROM heartbeat LIMIT 1&quot;, $dbh );

 if ( !$result || false === $row = mysql_fetch_assoc( $result ) )
  return false;

 // Cache the result in shared memory with timestamp
 $sem_id = sem_get( $wpdb-&amp;gt;shmem_key, 1, 0600, 1 ) ;
 sem_acquire( $sem_id );
 $segment = shm_attach( $wpdb-&amp;gt;shmem_key, $wpdb-&amp;gt;shmem_size, 0600 );
 $lag_data = @shm_get_var( $segment, 0 );

 if ( !is_array( $lag_data ) )
  $lag_data = array();

 $lag_data[ $wpdb-&amp;gt;lag_cache_key ] = array( &#39;timestamp&#39; =&amp;gt; time(), &#39;lag&#39; =&amp;gt; $row[ &#39;lag&#39; ] );
 shm_put_var( $segment, 0, $lag_data );
 shm_detach( $segment );
 sem_release( $sem_id );

 return $row[ &#39;lag&#39; ];
}&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Итак, как работает отслеживание:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Перед тем, как устанавливать соединение с базой, мы смотрим нет ли у нас данных в кэшэ о статусе её отставания.
Время жизни кэша задаётся через &lt;code class=&quot;highlighter-rouge&quot;&gt;$wpdb-&amp;gt;lag_cache_ttl&lt;/code&gt;. Использования кэша позволяет нам не генерировать дополнительных запросов в базу без необходимости.&lt;/li&gt;
  &lt;li&gt;Если данных нет или кэш протух, проверяем отставание с помощью запроса к табличке heartbeat. Получаем время отставания и записываем в кэш.&lt;/li&gt;
  &lt;li&gt;Первая или вторая функция вернёт нам время отставания слэйва. Оно сравнивается с &lt;code class=&quot;highlighter-rouge&quot;&gt;lag_threshold&lt;/code&gt;, которое определяется при добавлении сервера в конфиге.&lt;/li&gt;
  &lt;li&gt;Если время отставания не превышает &lt;code class=&quot;highlighter-rouge&quot;&gt;lag_threshold&lt;/code&gt;, то читаем со слэйва, в противном случае закрываем все соединения с этой базой и читаем с мастера.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Конфиг поправили, как работает поняли. Осталось настроить &lt;code class=&quot;highlighter-rouge&quot;&gt;mk-heartbeat&lt;/code&gt; для мониторинга отставания.&lt;/p&gt;

&lt;h2 id=&quot;mk-heartbeat&quot;&gt;Настройка mk-heartbeat&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;http://www.maatkit.org/doc/mk-heartbeat.html&quot;&gt;mk-heartbeat&lt;/a&gt; - утилита, входящая в пакет &lt;code class=&quot;highlighter-rouge&quot;&gt;maatkit&lt;/code&gt;, для мониторинга лагов репликации баз данных. В начале статьи мы уже установили нужный пакет на мастер(db1).&lt;/p&gt;

&lt;p&gt;Два слова о том, как происходит мониторинг:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Демон, запущенный на мастере, раз в дельту времени пишет timestamp в табличку heartbeat в реплицируемой базе данных.&lt;/li&gt;
  &lt;li&gt;Средствами репликации эти данные попадают на слейв.&lt;/li&gt;
  &lt;li&gt;Функция get_lag, в hyperdb, сравнивает текущий timestamp с записью в табличке, получая время расхождения репликации.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Запускаем демон. Он автоматически создаст нужную таблицу:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-console&quot; data-lang=&quot;console&quot;&gt;# mk-heartbeat --daemonize --create-table --table heartbeat -D wordpress --interval 27 --update&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Эта команда запустит демон, который создаст таблицу heartbeat в базе wordpress и будет записывать timestamp раз в 27 секунд (этого достаточно для проверки отставания не более минуты).&lt;/p&gt;

&lt;p&gt;При желании можно обернуть запуск демона в инит-скрипт и запускать при старте сервера.&lt;/p&gt;

&lt;p&gt;Собственно теперь мы отслеживаем лаги репликации и отдаём пользователям наисвежайшие данные из баз.&lt;/p&gt;
</description>
        <pubDate>Fri, 22 Mar 2013 18:02:00 +0200</pubDate>
        <link>https://cyberflow.net/clusters/linux/ha/2013/03/22/hyperdb-to-wordpress.html</link>
        <guid isPermaLink="true">https://cyberflow.net/clusters/linux/ha/2013/03/22/hyperdb-to-wordpress.html</guid>
        
        <category>availability</category>
        
        <category>cluster</category>
        
        <category>db</category>
        
        <category>hyperdb</category>
        
        <category>mysql</category>
        
        <category>scaling</category>
        
        <category>wordpress howto</category>
        
        
        <category>clusters</category>
        
        <category>linux</category>
        
        <category>ha</category>
        
      </item>
    
      <item>
        <title>Добавление Facebook комментариев к Octopress</title>
        <description>&lt;p&gt;В этой небольшой статья я опишу как добавить комментарии facebook к блогу на &lt;a href=&quot;http://octopres.org&quot;&gt;octopress&lt;/a&gt;. В octopress есть поддержка комментариев с использованием &lt;a href=&quot;http://disqus.com/&quot;&gt;disqus&lt;/a&gt;, но мне ближе facebook.&lt;/p&gt;

&lt;p&gt;Для начала необходимо &lt;a href=&quot;https://developers.facebook.com/apps&quot;&gt;зарегистрировать приложение на facebook&lt;/a&gt; для своего блога. Когда регистрация пройдена facebook  должен выдать app id. Теперь можно приступить к настройке. Добавим facebook app id и параметры отображения комментариев в файл конфигурации &lt;code class=&quot;highlighter-rouge&quot;&gt;_config.yml&lt;/code&gt;&lt;/p&gt;

&lt;blockquote class=&quot;filename&quot;&gt;
  &lt;p&gt;_config.yml&lt;/p&gt;
&lt;/blockquote&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-yml&quot; data-lang=&quot;yml&quot;&gt;&lt;span class=&quot;c1&quot;&gt;# Facebook comments&lt;/span&gt;
&lt;span class=&quot;s&quot;&gt;facebook&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;appid&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;222612811167194&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;num_post&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;5&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;width&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;789&lt;/span&gt;
  &lt;span class=&quot;s&quot;&gt;colorscheme&lt;/span&gt;&lt;span class=&quot;pi&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;light&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Следующим шагом добавим facebook javascript API на нашу страницу. Для этого можно воспользоваться уже имеющимся в octopress функционалом facebook like. И так, открываем &lt;code class=&quot;highlighter-rouge&quot;&gt;siurce/_includes/facebook_like.html&lt;/code&gt; и меняем строчку содержащую &lt;code class=&quot;highlighter-rouge&quot;&gt;js.src=&lt;/code&gt; заменив в ней цифры на app id полученный от facebook.
&lt;!--more--&gt;&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-js&quot; data-lang=&quot;js&quot;&gt;&lt;span class=&quot;nx&quot;&gt;js&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;//connect.facebook.net/en_US/all.js#appId=222612811167194&amp;amp;xfbml=1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Теперь переходим к добавлению комментариев на страницы блога. Создаём файл &lt;code class=&quot;highlighter-rouge&quot;&gt;source/_includes/post/facebook_comments.html&lt;/code&gt; и добавляем в него следующее:&lt;/p&gt;

&lt;blockquote class=&quot;filename&quot;&gt;
  &lt;p&gt;facebook_comments.html&lt;/p&gt;
&lt;/blockquote&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-html&quot; data-lang=&quot;html&quot;&gt;&lt;span class=&quot;nt&quot;&gt;&amp;lt;noscript&amp;gt;&lt;/span&gt;Please enable JavaScript to view the comments powered by facebook&lt;span class=&quot;nt&quot;&gt;&amp;lt;/a&amp;gt;&amp;lt;/noscript&amp;gt;&lt;/span&gt;
&lt;span class=&quot;nt&quot;&gt;&amp;lt;div&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;class=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;fb-comments&quot;&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;data-href=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;{{ site.url }}{{ page.url }}&quot;&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;data-num-posts=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;{{ site.facebook.num_post }}&quot;&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;data-width=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;{{ site.facebook.width }}&quot;&lt;/span&gt;
  &lt;span class=&quot;na&quot;&gt;data-colorscheme=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;{{ site.facebook.colorscheme }}&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;&amp;gt;&amp;lt;/div&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Этот шаблон теперь можно вставлять в любое место блога, где вам хочется добавить комментарии. Осталось добавить их в посты и страницы блога. Страницы и посты строятся на основе &lt;code class=&quot;highlighter-rouge&quot;&gt;post.html&lt;/code&gt; и &lt;code class=&quot;highlighter-rouge&quot;&gt;page.html&lt;/code&gt; файлов из директории &lt;code class=&quot;highlighter-rouge&quot;&gt;source/.layouts&lt;/code&gt;. ДОбавляем в них следующий код до или после блока кода, отвечающего за комментарии disqus:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-html&quot; data-lang=&quot;html&quot;&gt;{% if site.facebook.appid and page.comments == true %} 
  &lt;span class=&quot;nt&quot;&gt;&amp;lt;section&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;h1&amp;gt;&lt;/span&gt;Comments&lt;span class=&quot;nt&quot;&gt;&amp;lt;/h1&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;div&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;id=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;facebook_comments&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;aria-live=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;polite&quot;&lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;&amp;gt;&lt;/span&gt;
      {% include post/facebook_comments.html %}
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
  &lt;span class=&quot;nt&quot;&gt;&amp;lt;/section&amp;gt;&lt;/span&gt;
{% endif %}&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;В целом это всё, что необходимо для добавления комментариев. Однако есть ещ&amp;gt; одна полезная вещь - добавление модерации. Для этого можно добавить следующую строку в файл &lt;code class=&quot;highlighter-rouge&quot;&gt;source/includes/custom/head.html&lt;/code&gt;:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-html&quot; data-lang=&quot;html&quot;&gt;{% if site.facebook.appid %}
&lt;span class=&quot;nt&quot;&gt;&amp;lt;meta&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;property=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;fb:app_id&quot;&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;content=&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;{{ site.facebook.appid }}&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;/&amp;gt;&lt;/span&gt;
{% endif %}&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Это должно разрешить модерацию всем админ пользователям вашего преложения в facebook.&lt;/p&gt;

&lt;p&gt;В статье использовались материалы с сайта &lt;a href=&quot;http://blog.grambo.me.uk/blog/2012/02/20/adding-facebook-comments-to-octopress/&quot;&gt;blog.grambo.me.uk&lt;/a&gt;&lt;/p&gt;
</description>
        <pubDate>Wed, 20 Mar 2013 12:11:00 +0200</pubDate>
        <link>https://cyberflow.net/jekyll/2013/03/20/adding-facebook-comment-to-octopress.html</link>
        <guid isPermaLink="true">https://cyberflow.net/jekyll/2013/03/20/adding-facebook-comment-to-octopress.html</guid>
        
        <category>jekyll</category>
        
        <category>facebook</category>
        
        <category>comments</category>
        
        
        <category>jekyll</category>
        
      </item>
    
      <item>
        <title>Настраиваем сервера на Clodo через Opscode Chef</title>
        <description>&lt;p&gt;Данная статья описывает возможность автоматической настройки виртуальных серверов (на примере хостинга &lt;a href=&quot;http://clodo.ru/&quot; title=&quot;Clodo.ru&quot;&gt;clodo&lt;/a&gt;) с помощью &lt;a href=&quot;http://www.opscode.com&quot;&gt;chef&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Заводим аккаунт в &lt;a href=&quot;http://www.opscode.com/&quot; title=&quot;Opscode&quot;&gt;opscode&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Добавляем free хостинг на 5 серверов.&lt;/p&gt;

&lt;p&gt;При создании необходимо скачать ключик валидотора и конфиг для &lt;a href=&quot;http://wiki.opscode.com/display/chef/Knife/&quot; title=&quot;Knife&quot;&gt;knife&lt;/a&gt; и поместить в &lt;code class=&quot;highlighter-rouge&quot;&gt;~/.chef/knife.rb&lt;/code&gt;.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-ruby&quot; data-lang=&quot;ruby&quot;&gt;&lt;span class=&quot;n&quot;&gt;current_dir&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;File&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;dirname&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;__FILE__&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;log_level&lt;/span&gt;                &lt;span class=&quot;ss&quot;&gt;:info&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;log_location&lt;/span&gt;             &lt;span class=&quot;no&quot;&gt;STDOUT&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;node_name&lt;/span&gt;                &lt;span class=&quot;s2&quot;&gt;&quot;cyberflow&quot;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;client_key&lt;/span&gt;               &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;current_dir&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/cyberflow.pem&quot;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;validation_client_name&lt;/span&gt;   &lt;span class=&quot;s2&quot;&gt;&quot;clodo-test-validator&quot;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;validation_key&lt;/span&gt;           &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;current_dir&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/clodo-test-validator.pem&quot;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;chef_server_url&lt;/span&gt;          &lt;span class=&quot;s2&quot;&gt;&quot;https://api.opscode.com/organizations/clodo-test&quot;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;cache_type&lt;/span&gt;               &lt;span class=&quot;s1&quot;&gt;&#39;BasicFile&#39;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;cache_options&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:path&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;HOME&#39;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/.chef/checksums&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;cookbook_path&lt;/span&gt;            &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;current_dir&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/../cookbooks&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Далее идём в &lt;a href=&quot;http://www.opscode.com/&quot; title=&quot;Opscode&quot;&gt;opscode&lt;/a&gt;, заводим клиента, и ключик для клиента кладём так же в &lt;code class=&quot;highlighter-rouge&quot;&gt;~/.chef/&lt;/code&gt;.
&lt;!--more--&gt;
&amp;gt;  При создании пользователя помните, что его имя не должно совпадать с именем аккаунта в &lt;a href=&quot;http://www.opscode.com/&quot; title=&quot;Opscode&quot;&gt;opscode&lt;/a&gt;. Это приведёт к коллизии и ошибке в доступе к функциям API и панели управления chef сервером.&lt;/p&gt;

&lt;p&gt;Теперь можно установить &lt;a href=&quot;http://wiki.opscode.com/display/chef/Knife/&quot; title=&quot;Knife&quot;&gt;knife&lt;/a&gt; и плагин к нему от &lt;a href=&quot;http://clodo.ru/&quot; title=&quot;Clodo.ru&quot;&gt;clodo&lt;/a&gt;:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;curl -L https://www.opscode.com/chef/install.sh | sudo bash
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;sudo aptitude install libxml2-dev libxslt1-dev
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;sudo gem install knife-clodo&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Определимся с целью. Для тестов допустим, что нам нужно устанавливать ВПС с &lt;a href=&quot;http://wordpress.org/&quot; title=&quot;WordPress&quot;&gt;wordpress&lt;/a&gt; на борту. Для это в &lt;a href=&quot;http://www.opscode.com/&quot; title=&quot;Opscode&quot;&gt;opscode&lt;/a&gt; уже есть соответствующий &lt;a href=&quot;https://github.com/opscode-cookbooks/wordpress&quot;&gt;рецепт&lt;/a&gt;. Но для его использования нам надо залить его(и ещё пару рецептов которые нужны по зависимостям) на наш chef-server. Делается это следующим образом:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;mkdir ~/cookbook &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; ~/cookbook
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;git clone git://github.com/opscode-cookbooks/wordpress.git
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;git clone git://github.com/opscode-cookbooks/apache2.git
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;git clone git://github.com/opscode-cookbooks/mysql.git
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;git clone git://github.com/opscode-cookbooks/php.git
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;git clone git://github.com/opscode-cookbooks/openssl.git
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;git clone git://github.com/opscode-cookbooks/build-essential.git
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;knife cookbook upload openssl wordpress php mysql apache2 build-essential xml&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;После установки можно приступать к магии. Для начала добавим в конфиг &lt;a href=&quot;http://wiki.opscode.com/display/chef/Knife/&quot; title=&quot;Knife&quot;&gt;knife&lt;/a&gt; данные аккаунта &lt;a href=&quot;http://clodo.ru/&quot; title=&quot;Clodo.ru&quot;&gt;clodo&lt;/a&gt;:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;cat &amp;gt;&amp;gt; ~/.chef/knife.rb &lt;span class=&quot;sh&quot;&gt;&amp;lt;&amp;lt; EOF
knife[:clodo_username] =         &#39;clodo@user.name&#39; 
knife[:clodo_api_key]   =        &#39;12345678890qwertyasdfgh&#39;
knife[:clodo_api_auth_url]      = &#39;api.clodo.ru&#39;
&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;EOF&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Волшебство&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;knife clodo server create -r &lt;span class=&quot;s2&quot;&gt;&quot;recipe[apt]&quot;&lt;/span&gt; -c ~/.chef/knife-clodo-test.rb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
--server-disk&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;5 --server-memory&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;256 --server-memory-max&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;512 -I 541 &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
--node-name test1 --server-name opscode-test --template-file ~/.chef/chef-full.erb &lt;span class=&quot;se&quot;&gt;\&lt;/span&gt;
--no-ssl-verify-peer --clodo-api-auth-url api.mn.clodo.ru&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

</description>
        <pubDate>Thu, 28 Feb 2013 00:00:00 +0200</pubDate>
        <link>https://cyberflow.net/chef/2013/02/28/use-opscode-chef-and-clodo-servers.html</link>
        <guid isPermaLink="true">https://cyberflow.net/chef/2013/02/28/use-opscode-chef-and-clodo-servers.html</guid>
        
        <category>chef</category>
        
        <category>clodo.ru</category>
        
        <category>knife</category>
        
        
        <category>chef</category>
        
      </item>
    
      <item>
        <title>Github pages, jekyll и custom plugins</title>
        <description>&lt;p&gt;Не секрет, что &lt;a href=&quot;https://github.com/mojombo/jekyll&quot;&gt;jekyll&lt;/a&gt; отличный движок для блогинга. Так же не секрет, что многие пользователи &lt;a href=&quot;https://github.com/mojombo/jekyll&quot;&gt;jekyll&lt;/a&gt; используют в качестве хостинга &lt;a href=&quot;http://pages.github.com/&quot;&gt;github pages&lt;/a&gt;. Однако, как всегда, есть нюансы. В случае с &lt;a href=&quot;http://pages.github.com/&quot;&gt;github pages&lt;/a&gt; это отсутствие поддержки custom plugins, коих для &lt;a href=&quot;https://github.com/mojombo/jekyll&quot;&gt;jekyll&lt;/a&gt; имеется в количестве. Есть масса вариантов хостить статику, но в этой статье речь пойдёт о том, как можно продолжать хоститься на &lt;a href=&quot;http://pages.github.com/&quot;&gt;github pages&lt;/a&gt; и использовать при этом плагины.&lt;/p&gt;

&lt;p&gt;Собственно и в этом вопросе не обошлось без вариантов, но лично для себя я выбрал вариант, который предложил &lt;a href=&quot;http://arademaker.github.com/blog/2011/12/01/github-pages-jekyll-plugins.html&quot;&gt;Alexandre Rademaker&lt;/a&gt;. Суть этого решения заключается в том, чтобы отказаться от генерации статики на стороне &lt;a href=&quot;http://github.com&quot;&gt;github&lt;/a&gt;, а генерить её локально. Однако красота метода заключается в том, что при этом все исходные данные продолжают находиться под контролем git-a.&lt;/p&gt;

&lt;p&gt;Теперь по сути:&lt;/p&gt;

&lt;p&gt;Мы будем использовать branch source для хранения сырых данных и самой начинки &lt;a href=&quot;https://github.com/mojombo/jekyll&quot;&gt;jekyll&lt;/a&gt;, тогда как в master бранче будет только статика, которая и будет раздаваться по средствам &lt;a href=&quot;http://pages.github.com/&quot;&gt;github pages&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Далее предполагается, что у нас уже есть репозиторий на &lt;a href=&quot;http://github.com&quot;&gt;github&lt;/a&gt;, где в мастер ветке лежит jekyll и сырые данные без статики. Теперь создаём новый branch:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;git branch &lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;git push origin &lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt;
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;git checkout &lt;span class=&quot;nb&quot;&gt;source&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Теперь создаём что нам надо, добавляем плагины и т.п.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;git status / git add / git commit&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Запускаем &lt;a href=&quot;https://github.com/mojombo/jekyll&quot;&gt;jekyll&lt;/a&gt;:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;jekyll&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Всё готово для выкладки на &lt;a href=&quot;http://pages.github.com/&quot;&gt;github pages&lt;/a&gt;:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;checkout master
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;cp -r _site/&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; . &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; rm -rf _site/ &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; touch .nojekyll
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;git status &amp;gt; git add &amp;gt; git commit
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;git push -all origin&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;В статье используются материалы с сайта:
&lt;a href=&quot;http://arademaker.github.com/blog/2011/12/01/github-pages-jekyll-plugins.html&quot;&gt;http://arademaker.github.com&lt;/a&gt;&lt;/p&gt;

</description>
        <pubDate>Thu, 28 Feb 2013 00:00:00 +0200</pubDate>
        <link>https://cyberflow.net/jekyll/2013/02/28/github-jekyll-custom-plugins.html</link>
        <guid isPermaLink="true">https://cyberflow.net/jekyll/2013/02/28/github-jekyll-custom-plugins.html</guid>
        
        <category>jekyll</category>
        
        <category>github</category>
        
        
        <category>jekyll</category>
        
      </item>
    
      <item>
        <title>Установка node.js на Linux (deb base)</title>
        <description>&lt;p&gt;Данная инструкция проверялась и работает на Debian 6.&lt;/p&gt;

&lt;p&gt;Устанавливаем пакеты, необходимые для сборки и удовлетворения зависимостей:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;sudo aptitude install g++ curl python libssl-dev apache2-utils git-core checkinstall&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Клонируем репозиторий с &lt;a href=&quot;http://github.com&quot;&gt;github&lt;/a&gt;:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; /usr/src &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; git clone git://github.com/ry/node.git&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Далее запускаем конфигурацию:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nb&quot;&gt;cd &lt;/span&gt;node &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; ./configure&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Теперь можно собрать пакет для нашей системы:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;checkinstall --fstrans&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;no --install&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;no --pkgname&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;node.js --pkgversion &lt;span class=&quot;s2&quot;&gt;&quot;0.5.9&quot;&lt;/span&gt; --default&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;После сборки пакета его можно поставить:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;dpkg -i node.js_0.5.9-1_amd64.deb&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;В статье использовались материалы со следующих сайтов:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://oodavid.tumblr.com/post/15090798307/how-to-install-node-js-on-linux&quot;&gt;How to install node js on linux&lt;/a&gt;&lt;/p&gt;

</description>
        <pubDate>Mon, 25 Feb 2013 00:00:00 +0200</pubDate>
        <link>https://cyberflow.net/debian/linux/2013/02/25/how-to-install-nodejs-on-linux-deb-base.html</link>
        <guid isPermaLink="true">https://cyberflow.net/debian/linux/2013/02/25/how-to-install-nodejs-on-linux-deb-base.html</guid>
        
        <category>debian</category>
        
        <category>nodejs</category>
        
        <category>howto</category>
        
        
        <category>debian</category>
        
        <category>linux</category>
        
      </item>
    
      <item>
        <title>Redmine 2.x обнуление пароля admin-a</title>
        <description>&lt;p&gt;Для обнуления пароля от пользователя admin в redmine 2.x выполните следующую команду из консоли находясь в директории с redmine&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;ruby script/rails runner &lt;span class=&quot;s1&quot;&gt;&#39;user = User.find(:first, :conditions =&amp;gt; {:admin =&amp;gt; true}) ; user.password, user.password_confirmation = &quot;password&quot;; user.save!&#39;&lt;/span&gt; -e production&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;
</description>
        <pubDate>Thu, 13 Dec 2012 00:00:00 +0200</pubDate>
        <link>https://cyberflow.net/notice/2012/12/13/redmine-2-admin-password-reset.html</link>
        <guid isPermaLink="true">https://cyberflow.net/notice/2012/12/13/redmine-2-admin-password-reset.html</guid>
        
        <category>redmine</category>
        
        <category>ruby</category>
        
        
        <category>notice</category>
        
      </item>
    
      <item>
        <title>Установка chef solo на debian 6 squeeze</title>
        <description>&lt;p&gt;Для начала установим необходимые пакеты для установки и работы cfeh-solo.&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;apt-get install sudo wget lsb-release&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Далее добавляем репозиторий opscode в списки репозиториев командой:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;deb http://apt.opscode.com/ &lt;/span&gt;&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;lsb_release -cs&lt;span class=&quot;sb&quot;&gt;`&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;-0.10 main&quot;&lt;/span&gt; | sudo tee /etc/apt/sources.list.d/opscode.list&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Теперь необходимо добавить ключи к репозиторию:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;sudo mkdir -p /etc/apt/trusted.gpg.d
gpg --keyserver keys.gnupg.net --recv-keys 83EF826A
gpg --export packages@opscode.com | sudo tee /etc/apt/trusted.gpg.d/opscode-keyring.gpg &amp;gt; /dev/null&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Обновим информацию о пакетах с учётом добавленного репозитория и установим opscode-keyring:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;sudo apt-get update &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; sudo apt-get install opscode-keyring&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Устанавливаем chef:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;sudo apt-get install chef&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;При установке будет задан вопрос о пути к серверу chef, т.к. мы делаем установку для chef-solo, то указываем там “none”.&lt;/p&gt;
</description>
        <pubDate>Thu, 18 Oct 2012 00:00:00 +0300</pubDate>
        <link>https://cyberflow.net/debian/chef/2012/10/18/install-chef-solo-to-debian-6-squeeze.html</link>
        <guid isPermaLink="true">https://cyberflow.net/debian/chef/2012/10/18/install-chef-solo-to-debian-6-squeeze.html</guid>
        
        <category>chef</category>
        
        <category>chef-solo</category>
        
        <category>debian</category>
        
        <category>squeeze</category>
        
        
        <category>debian</category>
        
        <category>chef</category>
        
      </item>
    
      <item>
        <title>Определение ФС на LVS томе</title>
        <description>&lt;p&gt;Для определения FS на LVS томе нам необходимо получить метаданные данные с тома, определяющие тип FS.&lt;/p&gt;

&lt;p&gt;Для начала нужно посотреть смещение на томе, чтобы определить откуда начинаются необходимые нам данные. Для этого можно выполнить команду:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;mdadm -E /dev/sas00/51501_24
/dev/sas00/51501_24:
          Magic : a92b4efc
        Version : 1.2
    Feature Map : 0x1
     Array UUID : a11a9dae:fa6f187e:fdce9334:ec1fe46b
           Name : xen10:md51501_24
  Creation Time : Wed Sep 26 12:01:52 2012
     Raid Level : raid1
   Raid Devices : 2

 Avail Dev Size : 10491904 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;5.00 GiB 5.37 GB&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
     Array Size : 10491880 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;5.00 GiB 5.37 GB&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
  Used Dev Size : 10491880 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;5.00 GiB 5.37 GB&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;**&lt;/span&gt;Data Offset : 2048 sectors&lt;span class=&quot;k&quot;&gt;**&lt;/span&gt;
   Super Offset : 8 sectors
          State : clean
    Device UUID : 58297892:37844649:cb27316e:2e2f8c0e

Internal Bitmap : 8 sectors from superblock
    Update Time : Fri Oct 12 10:30:43 2012
       Checksum : 6b31c0a0 - correct
         Events : 6786


   Device Role : Active device 0
   Array State : AA &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&#39;A&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; active, &lt;span class=&quot;s1&quot;&gt;&#39;.&#39;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; missing&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Далее мы можем получить суберблок и определить тип файловой системы:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;dd &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/sas00/51501_24 &lt;span class=&quot;nv&quot;&gt;skip&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2048 &lt;span class=&quot;nv&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1k &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1024 | file -
/dev/stdin: Linux rev 1.0 ext4 filesystem data, &lt;span class=&quot;nv&quot;&gt;UUID&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;afb28ffa-9663-4f2e-94cb-9d05abfd1b76 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;needs journal recovery&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;extents&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;large files&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;huge files&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Том, который использовался для примера содержит FS ext4&lt;/p&gt;
</description>
        <pubDate>Fri, 12 Oct 2012 00:00:00 +0300</pubDate>
        <link>https://cyberflow.net/linux/2012/10/12/identify-fs-on-lvs-volume.html</link>
        <guid isPermaLink="true">https://cyberflow.net/linux/2012/10/12/identify-fs-on-lvs-volume.html</guid>
        
        <category>lvs</category>
        
        <category>howto</category>
        
        <category>fs</category>
        
        
        <category>linux</category>
        
      </item>
    
      <item>
        <title>Install debian to HP ProLiant with bnx2</title>
        <description>&lt;h3 id=&quot;section&quot;&gt;Введение&lt;/h3&gt;
&lt;p&gt;При установки Debian 6 на HP ProLiant DL360 сталкнулся с тем, что в образе netinstall нет fireware для сетевой карточки Broadcom Corporation NetXtreme II. Собственно инсталлятор в курсе этого и предлагает поискать соответствующий fireware на внешнем носителе. В этой заметке я опишу как быстро создать *.img файл с нужными fireware, который в последствии можно смонтировать через ipmi-kvm и скормить инсталлятору.&lt;/p&gt;

&lt;h3 id=&quot;fireware&quot;&gt;Поиск fireware&lt;/h3&gt;
&lt;p&gt;Собственно для debian 6 есть &lt;a href=&quot;http://packages.debian.org/squeeze/firmware-bnx2&quot;&gt;пакет&lt;/a&gt; со всем необходимым, и всё бы ничего, но вот без настроенной сетевой карты поставить этот пакет в систему не простая задача. Но т.к. в пакете есть всё необходимое, то качаем &lt;a href=&quot;http://ftp.de.debian.org/debian/pool/non-free/f/firmware-nonfree/firmware-nonfree_0.28+squeeze1.tar.gz&quot;&gt;сырцы&lt;/a&gt; пакета, распаковываем и приступаем к созданию образа.&lt;/p&gt;

&lt;h3 id=&quot;img-&quot;&gt;Создание IMG файла&lt;/h3&gt;
&lt;p&gt;Создайм бланковый файл, который будет у нас образом флоппи-диска, и создаём в нём файловую систему:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;dd &lt;span class=&quot;nv&quot;&gt;bs&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;512 &lt;span class=&quot;nv&quot;&gt;count&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;2880 &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;/dev/zero &lt;span class=&quot;nv&quot;&gt;of&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;imagefile.img
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;mkfs.msdos imagefile.img&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Далее монтируем наш флоппи-образ:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;sudo mkdir /media/floppy1/
&lt;span class=&quot;gp&quot;&gt;$ &lt;/span&gt;sudo mount -o loop imagefile.img /media/floppy1/&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Теперь кладём файлы, который просит инстолятор в /media/floppy1/, отмонтируем образ и скармливаем файл с образом инсталятору.&lt;/p&gt;

</description>
        <pubDate>Mon, 27 Aug 2012 00:00:00 +0300</pubDate>
        <link>https://cyberflow.net/debian/linux/2012/08/27/install-debian-to-hp-proliant-with-bnx2.html</link>
        <guid isPermaLink="true">https://cyberflow.net/debian/linux/2012/08/27/install-debian-to-hp-proliant-with-bnx2.html</guid>
        
        <category>debian</category>
        
        <category>bnx2</category>
        
        <category>fireware</category>
        
        
        <category>debian</category>
        
        <category>linux</category>
        
      </item>
    
      <item>
        <title>Fix invalid date format in specification Ruby</title>
        <description>&lt;p&gt;После обновления Ubuntu с 11.04 до версии 11.10 столкнулся с постоянной ошибкой при работе с ruby вида:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;Invalid gemspec &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;/var/lib/gems/1.8/specifications/directory_watcher-1.4.1.gemspec]: invalid date format &lt;span class=&quot;k&quot;&gt;in &lt;/span&gt;specification: &lt;span class=&quot;s2&quot;&gt;&quot;2011-08-30 00:00:00.000000000Z&quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;p&gt;Версия ruby 1.8.7&lt;/p&gt;

&lt;p&gt;Для лечения этой проблемы необходимо поправить строчку в проблемной спеке, заменив строчку:&lt;/p&gt;

&lt;p&gt;&lt;em&gt;s.date = %q{2011-05-21 00:00:00.000000000Z}&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;на&lt;/p&gt;

&lt;p&gt;&lt;em&gt;s.date = %q{2011-05-21}&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;Для конкретно моего случая надо править &lt;em&gt;/var/lib/gems/1.8/specifications/directory_watcher-1.4.1.gemspec&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;WIN!&lt;/p&gt;
</description>
        <pubDate>Sat, 05 May 2012 00:00:00 +0300</pubDate>
        <link>https://cyberflow.net/ruby/2012/05/05/fix-invalid-date-format-in-specification-ruby.html</link>
        <guid isPermaLink="true">https://cyberflow.net/ruby/2012/05/05/fix-invalid-date-format-in-specification-ruby.html</guid>
        
        <category>ruby</category>
        
        
        <category>ruby</category>
        
      </item>
    
      <item>
        <title>Nagios plugin check_smsc</title>
        <description>&lt;p&gt;В процессе настройки и работы с мониторинг-сервером icinga был использован ресурс &lt;a href=&quot;http://smsc.ru&quot;&gt;smsc.ru&lt;/a&gt; для нотификации смс. В итоге это вылилось в задачу мониторинга баланса на этом ресурсе. Собственно после чего и был написан небольшой плагин для мониторинга баланса.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/cyberflow/nagios_plugin/tree/master/check_smsc&quot;&gt;check_smsc&lt;/a&gt;&lt;/p&gt;

&lt;h3 id=&quot;section&quot;&gt;Документация&lt;/h3&gt;

&lt;p&gt;Данный плагин позволяет получить данные о состоянии счёт &lt;a href=&quot;http://smsc.ru&quot;&gt;smsc.ru&lt;/a&gt; и устанавливать значения для предупреждений. В качестве параметров плагину передаются логин и пароль в md5hash (пароль можно передать и в явном виде, но делать этого не рекомендуется).&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Опции:&lt;/em&gt;&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;-l/--login
	Логин от аккаунта smsc.ru
-p/--pass
	Пароль от аккаунта в md5hash
-w/--warning
	Определяется значение баланса, меньше которого будет выдаваться предупреждение.
	По умолчанию выключено.
-c/--critical
	Определяется значение баланса, меньше которого будет выдаваться критическое предупреждение.
	По умолчанию выключено.
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;p&gt;&lt;br /&gt;
&lt;em&gt;Пример использования:&lt;/em&gt;&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;check_smsc.sh -l login -p 50207fa2814e81a067bd2662ba10b0f1 -w 200 -c 100&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

&lt;h3 id=&quot;section-1&quot;&gt;Дополнительная информация&lt;/h3&gt;

&lt;p&gt;Для перевода пароля в md5hash можно воспользоваться командой:&lt;/p&gt;

&lt;figure class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; -n &lt;span class=&quot;s2&quot;&gt;&quot;password&quot;&lt;/span&gt; | md5sum -&lt;/code&gt;&lt;/pre&gt;&lt;/figure&gt;

</description>
        <pubDate>Thu, 26 Apr 2012 00:00:00 +0300</pubDate>
        <link>https://cyberflow.net/perl/monitoring/2012/04/26/nagios-plugin-check_smsc.html</link>
        <guid isPermaLink="true">https://cyberflow.net/perl/monitoring/2012/04/26/nagios-plugin-check_smsc.html</guid>
        
        <category>bash</category>
        
        <category>nagios</category>
        
        <category>plugins</category>
        
        <category>smsc</category>
        
        <category>monitoring</category>
        
        
        <category>perl</category>
        
        <category>monitoring</category>
        
      </item>
    
      <item>
        <title>Установка idoutils и icinga-web 1.5.2</title>
        <description>&lt;h3 id=&quot;section&quot;&gt;Для чего это нужно?&lt;/h3&gt;
&lt;p&gt;В дефолтной инсталляции &lt;a href=&quot;http://www.icinga.org&quot;&gt;icinga&lt;/a&gt; пишет все данные в файлики. Но есть возможность перенаправлять эти данные в базу при помощи idoutils. В целом в базе будут храниться все события, perf-data и другие данные.&lt;/p&gt;

&lt;h3 id=&quot;section-1&quot;&gt;Перед тем как начать&lt;/h3&gt;
&lt;p&gt;Подразумевается, что icinga 1.5.1 уже установлена и дальше будет только описание необходимых действия для установки idoutils и icinga-web 1.5.2. И то и другое требует базу данных. По этому убедитесь, что в вашем debian установлен соответствующий пакет. Если это не так, то установите его. Также необходимо наличии libdbi:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# apt-get install mysql-server mysql-client libdbi0 libdbi0-dev libdbd-mysql
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Для установки icinga-web 1.5.2 необходимы следующие пакеты:
&lt;!--more--&gt;&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# apt-get install apache2 build-essential libgd2-xpm-dev php5 php5-cli php-pear php5-xmlrpc php5-xsl php5-gd php5-ldap php5-mysql make
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;idoutils&quot;&gt;Установка idoutils&lt;/h3&gt;
&lt;p&gt;В бэкпортах debiana есть необходимые пакеты для установки idoutils. Ставим:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# aptitude -t squeeze-backports install icinga-idoutils icinga-phpapi
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;В процессе установки пакет должен попытаться сконфигурировать базу данных. Вам будет необходимо ввести пароль от пользователя базы данных icinga.&lt;/p&gt;

&lt;p&gt;Копируем пример конфига:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;cp /etc/icinga/modules/idoutils.cfg-sample /etc/icinga/modules/idoutils.cfg
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Правим конфиг:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;gd&quot;&gt;--- idoutils.cfg 2011-11-02 14:05:26.000000000 +0000
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+++ idoutils.cfg-sample 2011-09-23 14:10:54.000000000 +0000
&lt;/span&gt;&lt;span class=&quot;gu&quot;&gt;@@ -7,6 +7,6 @@
&lt;/span&gt; define module{
         module_name     idomod
         module_type     neb
&lt;span class=&quot;gd&quot;&gt;-        path            /usr/lib/icinga/idomod.o
&lt;/span&gt;&lt;span class=&quot;gi&quot;&gt;+        path            /usr/sbin/idomod.o
&lt;/span&gt;         args            config_file=/etc/icinga/idomod.cfg
  }
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Правим &lt;code class=&quot;highlighter-rouge&quot;&gt;/etc/default/icinga&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;IDO2DB&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;yes
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;После этого нужно перезапустить сервисы &lt;em&gt;ido2bd&lt;/em&gt; и &lt;em&gt;icinga&lt;/em&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-console&quot;&gt;#  /etc/init.d/ido2db restart
#  /etc/init.d/icinga restart
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Если всё настроено правильно, то в логах icinga должна появится запись:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;...
Event broker module &#39;/usr/lib/icinga/idomod.o&#39; initialized successfully.
...
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;

&lt;h3 id=&quot;icinga-web-152&quot;&gt;Установка icinga-web 1.5.2&lt;/h3&gt;
&lt;p&gt;На данный момент этот веб-интерфей icinga не упакован в пакет для Debian. По этому ставить будем руками.
Для начала необходимо скачать &lt;a href=&quot;https://sourceforge.net/projects/icinga/files/icinga-web/1.5.2/icinga-web-1.5.2.tar.gz/download&quot;&gt;исходники&lt;/a&gt; с веб интерфейсом.
Скачиваем архив в &lt;code class=&quot;highlighter-rouge&quot;&gt;/usr/src/&lt;/code&gt; и расспаковываем:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-console&quot;&gt;# tar xzvf icinga-web-1.5.2.tar.gz
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Icinga-Web имеет некоторые конфигурационные опции, которые помогут в дальнейшей инсталляции:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# ./configure
--prefix=/usr/local/icinga-web
--with-web-user=www-data
--with-web-group=www-data
--with-web-apache-path=/etc/apache2/conf.d
--with-db-type=mysql
--with-db-host=localhost
--with-db-port=3306
--with-db-name=icinga_web
--with-db-user=icinga_web
--with-db-pass=icinga_web
--with-conf-folder=etc/conf.d
--with-log-folder=log
&lt;/code&gt;&lt;/pre&gt;
&lt;/div&gt;
&lt;p&gt;Имейте в виду, что вы настраиваете БД для Icinga-Web, а не для Icinga. Это разные БД.
Далее выполняем следующие команды:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-console&quot;&gt;# make install &amp;amp;&amp;amp; make install-apache-config &amp;amp;&amp;amp; make install-done
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;section-2&quot;&gt;Подготовка БД&lt;/h3&gt;
&lt;p&gt;Icinga-Web требует для работы базу данных. Вы можете использовать базу icinga, но рекомендуется создать отдельную БД icinga_web&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-console&quot;&gt;# mysql -u root -p
mysql&amp;amp;gt; CREATE DATABASE icinga_web;

GRANT USAGE ON *.* TO &#39;icinga_web&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;icinga_web&#39;;
GRANT ALL PRIVILEGES ON icinga.* TO &#39;icinga&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;icinga&#39;;
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, ALTER, INDEX ON icinga_web.* TO &#39;icinga_web&#39;@&#39;localhost&#39;;

quit
# make db-initialize
# /usr/local/icinga-web/bin/clearcache.sh
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;section-3&quot;&gt;Запуск&lt;/h3&gt;
&lt;p&gt;Для корректной работы веб-интерфейса необходимо включить модуль &lt;code class=&quot;highlighter-rouge&quot;&gt;rewrite&lt;/code&gt; веб-сервера:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-console&quot;&gt;# a2enmod rewrite
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Теперь нужно перечитать настройки &lt;em&gt;apache&lt;/em&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;language-console&quot;&gt;# /etc/init.d/apache2 reload
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Icinga-web по умолчанию доступна по адресу http://serverhostname/icinga-web/.Также по умолчанию авторизация происходит с помощью логина &lt;code class=&quot;highlighter-rouge&quot;&gt;root&lt;/code&gt; и пароля &lt;code class=&quot;highlighter-rouge&quot;&gt;password&lt;/code&gt;.&lt;/p&gt;
</description>
        <pubDate>Thu, 03 Nov 2011 09:28:00 +0200</pubDate>
        <link>https://cyberflow.net/monitoring/2011/11/03/idoutils-icinga-web-1-dot-5-2.html</link>
        <guid isPermaLink="true">https://cyberflow.net/monitoring/2011/11/03/idoutils-icinga-web-1-dot-5-2.html</guid>
        
        <category>apache2</category>
        
        <category>debian</category>
        
        <category>linux</category>
        
        <category>icinga</category>
        
        <category>icinga-web</category>
        
        <category>ido2db</category>
        
        <category>monitoring</category>
        
        
        <category>monitoring</category>
        
      </item>
    
  </channel>
</rss>
