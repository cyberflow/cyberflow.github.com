<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="shortcut icon" href="/static/img/favicon.ico" />
        <title>Cyberflow</title>
        <meta name="author" content="Cyberflow" />
        <meta name="description" content="My Personal Blog" />
        <meta name="keywords" content="Cyberflow, monitoring, perl, ruby, debian, linux, chef, notice, jekyll, clusters, ha, elasticsearch, databases" />
        <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/static/css/syntax.css">

        <!-- Bootstrap core CSS -->
        <link href="/static/css/bootstrap.min.css" rel="stylesheet">

        <!-- Fonts -->
        <link href="//fonts.googleapis.com/css?family=Roboto+Condensed:400,300italic,300,400italic,700&amp;subset=latin,latin-ext" rel="stylesheet" type="text/css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/static/css/super-search.css">
        <link rel="stylesheet" href="/static/css/main.css">

        <!-- Google Analytics -->
        
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-31213444-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


    </head>

    <body>
        <div class="container">
            <div class="col-sm-3">
                <a href="/"><img id="about" src="https://www.gravatar.com/avatar/7ca36522be02d33e7d2f4ea209012ac3?s=68" alt="cyberflow_gravatar" height="75px" width="75px" /></a>
                <h1 class="author-name">Cyberflow</h1>
                
                <div id="about">
                    I am linux system administrator.
                </div>
                

                <hr />
                <div class="search" id="js-search">
                  <input type="text" placeholder="(sitemap)~$ type to search" class="search__input form-control" id="js-search__input">
                  <ul class="search__results" id="js-search__results"></ul>
                </div>
                <hr />

                <strong>Navigation</strong><br />
                    &raquo; <a href="/">Home</a> <br />
                
                    &raquo; <a class="about" href="/category/">Categories</a><br />
                
                    &raquo; <a class="about" href="https://github.com/cyberflow">Github</a><br />
                
                    &raquo; <a class="about" href="/feed.xml">XML Feed</a><br />
                
            </div>

            <div class="col-sm-8 col-offset-1">
                <div id="home">
    <h1>Cyberflow</h1>
    <hr />
    <ol class="posts">
    
      
      
<header>
  <h1 class="entry-title"><a href="/2013/08/replication-chef-database.html">Репликация таблиц базы chef-server </a></h1>
  
    <p class="meta">
      09 Aug 2013
      
       | <a href="/2013/08/replication-chef-database.html#disqus_thread">Comments</a>
      
    </p>
  
</header>
<div class="content"><h3 id="intro">Intro</h3>
<p>В данной статье я расскажу как настроить два сервера <a href="http://www.opscode.com" title="Opscode">chef-server</a> версии 11 с репликацией части таблиц базы postgresql для обеспечения отказоустойчивости. Основная цель репликации это хранения данных о клиентах и нодах для прозрачного доступа нод к любому из <a href="http://www.opscode.com" title="Opscode">chef</a> серверов и возможности работы без перерегистрации. Предлагаемое <a href="http://www.opscode.com" title="Opscode">opscode</a> решение репликации данных через DRBD показалось мне не самым удобным и, главное, надёжным. По сему было принято решение искать альтернативные пути. Так как реплицировать все данные из всех таблиц нет необходимости, то было решено посмотреть в сторону <a href="http://wiki.postgresql.org/wiki/Skytools">skytools</a> и <a href="http://wiki.postgresql.org/wiki/Skytools#Londiste">londiste</a>, которые позволяют реплицировать только определенные таблицы БД.</p>

<p>Однако не обошлось без сюрпризов. <a href="http://www.opscode.com" title="Opscode">Opscode</a> распространяет shef-server 11 по средствам уже собранных omnibus пакетов, в котором свой postgres 9.2. Этот постгрес собран урезанным и не работает с skytools. В итоге в этой статье будет описано как поставить chef-server из omnibus пакета на дистрибутивный postgres 9.2 и прикрутить репликацию через londiste.</p>

</div>

  <footer>
    <a rel="full-article" href="/2013/08/replication-chef-database.html">Read on &rarr;</a>
  </footer>


    
      
      
<header>
  <h1 class="entry-title"><a href="/2013/05/logstash-rotate-logs-in-elasticsearch.html">logstash, ротация логов в elasticsearch</a></h1>
  
    <p class="meta">
      31 May 2013
      
       | <a href="/2013/05/logstash-rotate-logs-in-elasticsearch.html#disqus_thread">Comments</a>
      
    </p>
  
</header>
<div class="content"><p>Небольшая заметка как организовать ротацию логов, собирающихся при помощи <a href="http://logstash.net/">logstash</a> в <a href="http://www.elasticsearch.org/">elasticsearch</a>.</p>

<p>В крон добавляем:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="sh">'</span><span class="no">EOF</span><span class="sh">' &gt; /etc/cron.daily/logstash<br data-jekyll-commonmark-ghpages="" />#!/bin/bash<br data-jekyll-commonmark-ghpages="" />logdate=</span><span class="k">$(</span>date <span class="nt">-d</span><span class="s1">'-15 days'</span> +<span class="s2">"%Y.%m.%d"</span><span class="k">)</span><span class="sh"><br data-jekyll-commonmark-ghpages="" />curl -XDELETE "http://localhost:9200/logstash-</span><span class="k">${</span><span class="nv">logdate</span><span class="k">}</span><span class="sh">"<br data-jekyll-commonmark-ghpages="" />EOF</span></code></pre></figure>

<p>Этот скрипт будет запускаться ежедневно и удалять все логи из elasticsearch 15-дневной давности.</p>
</div>


    
      
      
<header>
  <h1 class="entry-title"><a href="/2013/03/hyperdb-to-wordpress.html">Hyperdb to Wordpress</a></h1>
  
    <p class="meta">
      22 Mar 2013
      
       | <a href="/2013/03/hyperdb-to-wordpress.html#disqus_thread">Comments</a>
      
    </p>
  
</header>
<div class="content"><p><a href="http://wordpress.org/extend/plugins/hyperdb/">Hyperdb</a> - это замена стандартоного класса <code class="highlighter-rouge">wpdb</code>, позволяющая использовать несколько баз данных.
В данной статье я опишу настройку hyperdb для распределенной инфраструктуры, состоящей из двух frontend серверов и двух серверов баз данных на базе дистрибутивов Debian 6, в качестве основной задачи ставилось не только распределение запросов на чтение между серверами БД, но и отслеживания отставаний слэйв сервера и, в случае отставания, чтение актуальных данных с мастера.</p>

<p>Настройка самих фронтендов оставим за кадром, т.к. это выходит за рамки данной статьи. Что касается серверов БД, то мы будем использовать мастер-слэйв репликацию и mk-heartbeat для отслеживания lag-ов на слэйве. Сервера геораспределены и каждый сервер БД располагается в отдельном ДЦ в паре с фронтендом. На настройке баз я остановлючь подробнее:</p>

<h2 id="Настройка-репликации-db">Настройка репликации DB:</h2>

<p>Здесь не описано ничего принципиально нового. Используется стандартная <a href="http://dev.mysql.com/doc/refman/5.1/en/replication.html">репликация Мастер-Слэйв</a> средствами MySql.</p>

</div>

  <footer>
    <a rel="full-article" href="/2013/03/hyperdb-to-wordpress.html">Read on &rarr;</a>
  </footer>


    
      
      
<header>
  <h1 class="entry-title"><a href="/2013/03/adding-facebook-comment-to-octopress.html">Добавление Facebook комментариев к Octopress</a></h1>
  
    <p class="meta">
      20 Mar 2013
      
       | <a href="/2013/03/adding-facebook-comment-to-octopress.html#disqus_thread">Comments</a>
      
    </p>
  
</header>
<div class="content"><p>В этой небольшой статья я опишу как добавить комментарии facebook к блогу на <a href="http://octopress.org">octopress</a>. В octopress есть поддержка комментариев с использованием <a href="http://disqus.com/">disqus</a>, но мне ближе facebook.</p>

<p>Для начала необходимо <a href="https://developers.facebook.com/apps">зарегистрировать приложение на facebook</a> для своего блога. Когда регистрация пройдена facebook  должен выдать app id. Теперь можно приступить к настройке. Добавим facebook app id и параметры отображения комментариев в файл конфигурации <code class="highlighter-rouge">_config.yml</code></p>

<blockquote class="filename">
  <p>_config.yml</p>
</blockquote>

<figure class="highlight"><pre><code class="language-yml" data-lang="yml"><span class="c1"># Facebook comments</span><br data-jekyll-commonmark-ghpages="" /><span class="na">facebook</span><span class="pi">:</span><br data-jekyll-commonmark-ghpages="" />  <span class="na">appid</span><span class="pi">:</span> <span class="s">222612811167194</span><br data-jekyll-commonmark-ghpages="" />  <span class="na">num_post</span><span class="pi">:</span> <span class="s">5</span><br data-jekyll-commonmark-ghpages="" />  <span class="na">width</span><span class="pi">:</span> <span class="s">789</span><br data-jekyll-commonmark-ghpages="" />  <span class="na">colorscheme</span><span class="pi">:</span> <span class="s">light</span></code></pre></figure>

<p>Следующим шагом добавим facebook javascript API на нашу страницу. Для этого можно воспользоваться уже имеющимся в octopress функционалом facebook like. И так, открываем <code class="highlighter-rouge">siurce/_includes/facebook_like.html</code> и меняем строчку содержащую <code class="highlighter-rouge">js.src=</code> заменив в ней цифры на app id полученный от facebook.</p>

</div>

  <footer>
    <a rel="full-article" href="/2013/03/adding-facebook-comment-to-octopress.html">Read on &rarr;</a>
  </footer>


    
      
      
<header>
  <h1 class="entry-title"><a href="/2013/02/use-opscode-chef-and-clodo-servers.html">Настраиваем сервера на Clodo через Opscode Chef</a></h1>
  
    <p class="meta">
      28 Feb 2013
      
       | <a href="/2013/02/use-opscode-chef-and-clodo-servers.html#disqus_thread">Comments</a>
      
    </p>
  
</header>
<div class="content"><p>Данная статья описывает возможность автоматической настройки виртуальных серверов (на примере хостинга clodo.ru) с помощью <a href="http://www.opscode.com">chef</a>.</p>

<p>Заводим аккаунт в <a href="http://www.opscode.com/" title="Opscode">opscode</a></p>

<p>Добавляем free хостинг на 5 серверов.</p>

<p>При создании необходимо скачать ключик валидотора и конфиг для <a href="https://docs.chef.io/knife.html" title="Knife">knife</a> и поместить в <code class="highlighter-rouge">~/.chef/knife.rb</code>.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">current_dir</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="kp">__FILE__</span><span class="p">)</span><br data-jekyll-commonmark-ghpages="" /><span class="n">log_level</span>                <span class="ss">:info</span><br data-jekyll-commonmark-ghpages="" /><span class="n">log_location</span>             <span class="no">STDOUT</span><br data-jekyll-commonmark-ghpages="" /><span class="n">node_name</span>                <span class="s2">"cyberflow"</span><br data-jekyll-commonmark-ghpages="" /><span class="n">client_key</span>               <span class="s2">"</span><span class="si">#{</span><span class="n">current_dir</span><span class="si">}</span><span class="s2">/cyberflow.pem"</span><br data-jekyll-commonmark-ghpages="" /><span class="n">validation_client_name</span>   <span class="s2">"clodo-test-validator"</span><br data-jekyll-commonmark-ghpages="" /><span class="n">validation_key</span>           <span class="s2">"</span><span class="si">#{</span><span class="n">current_dir</span><span class="si">}</span><span class="s2">/clodo-test-validator.pem"</span><br data-jekyll-commonmark-ghpages="" /><span class="n">chef_server_url</span>          <span class="s2">"https://api.opscode.com/organizations/clodo-test"</span><br data-jekyll-commonmark-ghpages="" /><span class="n">cache_type</span>               <span class="s1">'BasicFile'</span><br data-jekyll-commonmark-ghpages="" /><span class="n">cache_options</span><span class="p">(</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">"</span><span class="si">#{</span><span class="no">ENV</span><span class="p">[</span><span class="s1">'HOME'</span><span class="p">]</span><span class="si">}</span><span class="s2">/.chef/checksums"</span> <span class="p">)</span><br data-jekyll-commonmark-ghpages="" /><span class="n">cookbook_path</span>            <span class="p">[</span><span class="s2">"</span><span class="si">#{</span><span class="n">current_dir</span><span class="si">}</span><span class="s2">/../cookbooks"</span><span class="p">]</span></code></pre></figure>

<p>Далее идём в <a href="http://www.opscode.com/" title="Opscode">opscode</a>, заводим клиента, и ключик для клиента кладём так же в <code class="highlighter-rouge">~/.chef/</code>.</p>

</div>

  <footer>
    <a rel="full-article" href="/2013/02/use-opscode-chef-and-clodo-servers.html">Read on &rarr;</a>
  </footer>


    
    </ol>

    <!-- Pagination links -->
    
    <ul class="pagination">
      
        <li>
          <a href="/page2/">&laquo;</a>
        </li>
      

      <li><a href="/">First</a></li>

      
        
          <li><a href="/">1</a></li>
        
      
        
          <li>
            <a href="/page2/">2</a>
          </li>
        
      
        
          <li class="active">
             <a>3<span class="sr-only">(current)</span></a>
          </li>
        
      
        
          <li>
            <a href="/page4/">4</a>
          </li>
        
      
        
          <li>
            <a href="/page5/">5</a>
          </li>
        
      

      <li><a href="/page5/">Last</a></li>

      
        <li>
          <a href="/page4/">&raquo;</a>
        </li>
      
    </ul>
    
</div><!-- end #home -->


                <footer>
                    &copy; Cyberflow
                    
                    - <a href="https://github.com/cyberflow">https://github.com/cyberflow</a> - Powered by Jekyll.
                    
                </footer>
            </div><!-- end /.col-sm-8 -->
        </div><!-- end /.container -->

        <!-- Bootstrap core JavaScript
        ================================================== -->
        <!-- Placed at the end of the document so the pages load faster -->
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
        <script src="/static/js/bootstrap.min.js"></script>
        <script src="/static/js/super-search.js"></script>
    </body>
</html>
